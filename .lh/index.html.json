{
    "sourceFile": "index.html",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 2,
            "patches": [
                {
                    "date": 1771976240371,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1771988527919,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,1 +0,0 @@\n-﻿\n\\ No newline at end of file\n"
                },
                {
                    "date": 1771989898327,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,1 @@\n+<\n\\ No newline at end of file\n"
                }
            ],
            "date": 1771976240371,
            "name": "Commit-0",
            "content": "<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>LEMEGETON: Path of the Zenith</title>\n    <link href=\"https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap\" rel=\"stylesheet\">\n    <style>\n        :root {\n            --ff-blue-top: #000066;\n            --ff-blue-bottom: #000033;\n            --ff-border: #ffffff;\n            --term-green: #00ff41;\n            --term-magenta: #ff00ff;\n            --term-cyan: #00ffff;\n            --term-yellow: #ffff00;\n            --term-white: #ffffff;\n            --glow: 0 0 10px rgba(0, 255, 255, 0.5);\n            --pixel-font: 'Press Start 2P', cursive;\n        }\n\n        body, html {\n            margin: 0; padding: 0;\n            background-color: #000;\n            color: var(--term-white);\n            font-family: var(--pixel-font);\n            font-size: 11px;\n            height: 100%;\n            overflow: hidden;\n        }\n\n        #main-layout {\n            display: flex;\n            height: 100vh;\n            width: 100vw;\n            box-sizing: border-box;\n            background: linear-gradient(to bottom, var(--ff-blue-top), var(--ff-blue-bottom));\n            padding: 10px;\n            gap: 10px;\n        }\n\n        .crt-overlay {\n            position: fixed;\n            top: 0; left: 0; bottom: 0; right: 0;\n            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.02), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.02));\n            z-index: 100;\n            background-size: 100% 2px, 3px 100%;\n            pointer-events: none;\n        }\n\n        .ff-window {\n            background: linear-gradient(135deg, rgba(0,0,102,0.85), rgba(0,0,51,0.95));\n            border: 2px solid var(--ff-border);\n            box-shadow: inset 0 0 0 2px #000, 0 0 15px rgba(0,0,0,0.5);\n            position: relative;\n            display: flex;\n            flex-direction: column;\n        }\n\n        #sidebar { width: 260px; padding: 15px; gap: 15px; flex-shrink: 0; }\n\n        .gui-panel {\n            border: 1px solid rgba(255,255,255,0.2);\n            padding: 10px;\n            background: rgba(255,255,255,0.05);\n            margin-bottom: 10px;\n        }\n\n        .gui-header {\n            font-weight: bold;\n            color: var(--term-cyan);\n            border-bottom: 1px solid rgba(255,255,255,0.2);\n            margin-bottom: 10px;\n            padding-bottom: 5px;\n            text-transform: uppercase;\n            font-size: 0.8em;\n        }\n\n        .stat-row { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 0.75em; }\n        .stat-value { color: var(--term-white); }\n\n        /* Clock Visual */\n        #heptagram-container {\n            position: relative;\n            width: 180px;\n            height: 180px;\n            margin: 10px auto;\n        }\n\n        .planet-node {\n            position: absolute;\n            width: 34px;\n            height: 34px;\n            border: 1px solid rgba(255,255,255,0.3);\n            border-radius: 50%;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            font-size: 18px;\n            background: rgba(0,0,0,0.5);\n            transition: all 0.3s;\n        }\n\n        .planet-node.active-day {\n            border: 2px solid var(--term-yellow);\n            box-shadow: 0 0 15px var(--term-yellow);\n            background: rgba(255, 255, 0, 0.2);\n        }\n\n        .planet-node.active-hour {\n            color: var(--term-magenta);\n            text-shadow: 0 0 8px var(--term-magenta);\n        }\n\n        /* Terminal */\n        #terminal-wrapper { flex: 1; overflow: hidden; }\n\n        .lore-terminal {\n            height: 100% !important;\n            width: 100% !important;\n            background-color: transparent !important;\n            color: var(--term-white) !important;\n            font-family: var(--pixel-font) !important;\n            padding: 15px !important;\n            box-sizing: border-box !important;\n            display: flex !important;\n            flex-direction: column !important;\n        }\n\n        .lore-output {\n            flex: 1 !important;\n            overflow-y: auto !important;\n            margin-bottom: 15px !important;\n            font-size: 10px;\n            line-height: 1.6 !important;\n        }\n\n        .lore-input-container {\n            background: rgba(0, 0, 0, 0.5) !important;\n            padding: 10px !important;\n            border: 1px solid rgba(255, 255, 255, 0.3);\n            display: flex !important;\n        }\n\n        .lore-input {\n            color: var(--term-cyan) !important;\n            font-family: var(--pixel-font) !important;\n            font-size: 11px !important;\n            background: transparent !important;\n            border: none !important;\n            outline: none !important;\n            flex: 1;\n            margin-left: 10px !important;\n        }\n\n        .lore-output::-webkit-scrollbar { width: 6px; }\n        .lore-output::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }\n\n        /* Menu Overlay */\n        #menu-overlay {\n            position: fixed;\n            top: 0; left: 0; width: 100%; height: 100%;\n            background: rgba(0,0,0,0.85);\n            z-index: 200;\n            display: none;\n            align-items: center;\n            justify-content: center;\n        }\n\n        #menu-window {\n            width: 500px;\n            height: 400px;\n            display: flex;\n            flex-direction: column;\n        }\n\n        .menu-tabs {\n            display: flex;\n            background: rgba(255,255,255,0.1);\n            border-bottom: 2px solid var(--ff-border);\n        }\n\n        .menu-tab {\n            padding: 10px 15px;\n            cursor: pointer;\n            text-transform: uppercase;\n            font-size: 0.8em;\n            border-right: 1px solid rgba(255,255,255,0.2);\n        }\n\n        .menu-tab.active {\n            background: var(--ff-blue-top);\n            color: var(--term-cyan);\n            border-bottom: 2px solid var(--term-cyan);\n            margin-bottom: -2px;\n        }\n\n        .menu-content {\n            flex: 1;\n            padding: 20px;\n            overflow-y: auto;\n        }\n\n        .menu-section { display: none; }\n        .menu-section.active { display: block; }\n\n        .menu-btn {\n            background: rgba(255,255,255,0.1);\n            border: 1px solid var(--ff-border);\n            color: white;\n            padding: 10px;\n            font-family: var(--pixel-font);\n            font-size: 0.7em;\n            cursor: pointer;\n            margin-bottom: 10px;\n            width: 100%;\n            text-align: left;\n        }\n\n        .menu-btn:hover {\n            background: rgba(255,255,255,0.2);\n            color: var(--term-yellow);\n        }\n\n        .menu-label {\n            font-size: 0.7em;\n            margin-bottom: 5px;\n            color: var(--term-cyan);\n            text-transform: uppercase;\n        }\n\n        input[type=\"range\"] {\n            width: 100%;\n            margin-bottom: 15px;\n        }\n\n        .server-code-display {\n            background: rgba(0,0,0,0.5);\n            border: 1px dashed var(--term-magenta);\n            padding: 15px;\n            text-align: center;\n            font-size: 1.2em;\n            color: var(--term-magenta);\n            margin: 10px 0;\n        }\n    </style>\n</head>\n<body>\n    <div class=\"crt-overlay\"></div>\n    <div id=\"main-layout\">\n        <aside id=\"sidebar\" class=\"ff-window\">\n            <div class=\"gui-panel\">\n                <div class=\"gui-header\">Planetary Clock</div>\n                <div id=\"stat-day-num\" class=\"stat-row\"><span>Day</span> <span class=\"stat-value\">1</span></div>\n                <div class=\"stat-row\"><span>Current Day</span> <span id=\"stat-day-sym\" class=\"stat-value\">♄</span></div>\n                <div class=\"stat-row\"><span>Current Hour</span> <span id=\"stat-hour-sym\" class=\"stat-value\">♄</span></div>\n                \n                <div id=\"heptagram-container\">\n                    <!-- Nodes will be positioned by JS -->\n                </div>\n            </div>\n\n            <div class=\"gui-panel\">\n                <div class=\"gui-header\">Vitals</div>\n                <div class=\"stat-row\"><span>SANITY</span> <span id=\"stat-sanity\" class=\"stat-value\">100</span></div>\n                <div class=\"stat-row\"><span>WRATH</span> <span id=\"stat-wrath\" class=\"stat-value\">0</span></div>\n                <div class=\"stat-row\"><span>LOYALTY</span> <span id=\"stat-loyalty\" class=\"stat-value\">0</span></div>\n            </div>\n\n            <div class=\"gui-panel\">\n                <div class=\"gui-header\">Status</div>\n                <div class=\"stat-row\"><span>PLAYER</span> <span id=\"stat-player\" class=\"stat-value\">Desdemona</span></div>\n                <div class=\"stat-row\"><span>RANK</span> <span id=\"stat-rank\" class=\"stat-value\">Novice</span></div>\n                <div class=\"stat-row\"><span>TURNS</span> <span id=\"stat-turns\" class=\"stat-value\">0</span></div>\n            </div>\n\n            <div class=\"gui-panel\" style=\"flex:1; overflow-y:auto;\">\n                <div class=\"gui-header\">Inventory</div>\n                <ul id=\"inventory-list\" style=\"list-style:none; padding:0; font-size:0.7em; color:var(--term-yellow);\"></ul>\n            </div>\n\n            <button id=\"btn-open-menu\" class=\"menu-btn\" style=\"margin-top:auto; text-align:center; border-width:2px;\">SYSTEM MENU</button>\n        </aside>\n\n        <main id=\"terminal-wrapper\" class=\"ff-window\">\n            <div id=\"game-container\" class=\"lore-terminal\"></div>\n        </main>\n    </div>\n\n    <div id=\"menu-overlay\">\n        <div id=\"menu-window\" class=\"ff-window\">\n            <div class=\"menu-tabs\">\n                <div class=\"menu-tab active\" data-tab=\"audio\">Audio</div>\n                <div class=\"menu-tab\" data-tab=\"save\">Save/Load</div>\n                <div class=\"menu-tab\" data-tab=\"settings\">Settings</div>\n                <div class=\"menu-tab\" data-tab=\"multi\">Multiplayer</div>\n                <div class=\"menu-tab\" id=\"btn-close-menu\" style=\"margin-left:auto; border-right:none; border-left:1px solid rgba(255,255,255,0.2);\">X</div>\n            </div>\n            <div class=\"menu-content\">\n                <!-- Audio Section -->\n                <div id=\"tab-audio\" class=\"menu-section active\">\n                    <div class=\"menu-label\">Master Volume</div>\n                    <input type=\"range\" id=\"volume-master\" min=\"0\" max=\"100\" value=\"80\">\n                    <div class=\"menu-label\">Music Volume</div>\n                    <input type=\"range\" id=\"volume-music\" min=\"0\" max=\"100\" value=\"60\">\n                    <button class=\"menu-btn\" id=\"btn-mute\">Mute All Audio</button>\n                </div>\n\n                <!-- Save/Load Section -->\n                <div id=\"tab-save\" class=\"menu-section\">\n                    <button class=\"menu-btn\" id=\"btn-save-game\">Save Game (Slot 1)</button>\n                    <button class=\"menu-btn\" id=\"btn-load-game\">Load Game (Slot 1)</button>\n                    <hr style=\"border:0; border-top:1px solid rgba(255,255,255,0.1); margin:15px 0;\">\n                    <button class=\"menu-btn\" id=\"btn-download-logs\" style=\"border-color:var(--term-green); color:var(--term-green);\">DOWNLOAD SESSION LOGS (.TXT)</button>\n                </div>\n\n                <!-- Settings Section -->\n                <div id=\"tab-settings\" class=\"menu-section\">\n                    <div class=\"menu-label\">Character Name</div>\n                    <div style=\"display:flex; gap:10px; margin-bottom:15px;\">\n                        <input type=\"text\" id=\"input-player-name\" style=\"flex:1; background:rgba(0,0,0,0.5); border:1px solid var(--ff-border); color:white; padding:5px; font-family:var(--pixel-font); font-size:0.7em;\" placeholder=\"Enter name...\">\n                        <button class=\"menu-btn\" id=\"btn-change-name\" style=\"width:auto; margin-bottom:0;\">SET</button>\n                    </div>\n                    <div class=\"menu-label\">Text Speed</div>\n                    <input type=\"range\" id=\"setting-text-speed\" min=\"1\" max=\"100\" value=\"20\">\n                    <button class=\"menu-btn\" id=\"btn-clear-history\">Clear Command History</button>\n                    <button class=\"menu-btn\" id=\"btn-reset-game\" style=\"border-color:var(--term-red); color:var(--term-red);\">Hard Reset Game</button>\n                </div>\n\n                <!-- Multiplayer Section -->\n                <div id=\"tab-multi\" class=\"menu-section\">\n                    <div id=\"multi-init\">\n                        <button class=\"menu-btn\" id=\"btn-multi-host\">Host New Session</button>\n                        <button class=\"menu-btn\" id=\"btn-multi-join\">Join Session with Code</button>\n                    </div>\n                    <div id=\"multi-hosting\" style=\"display:none;\">\n                        <div class=\"menu-label\">Server Code</div>\n                        <div class=\"server-code-display\" id=\"display-server-code\">----</div>\n                        <div class=\"menu-label\">Players (1/4)</div>\n                        <ul id=\"multi-player-list\" style=\"font-size:0.7em; margin-bottom:15px;\">\n                            <li>Desdemona (NPC)</li>\n                            <li id=\"li-me-player\" style=\"color:var(--term-green);\">You (Cultist 1)</li>\n                        </ul>\n                        <button class=\"menu-btn\" id=\"btn-stop-multi\">Stop Hosting</button>\n                        <button class=\"menu-btn\" id=\"btn-leave-multi\" style=\"display:none;\">Leave Session</button>\n                    </div>\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <script src=\"lore.js\"></script>\n    <script src=\"https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js\"></script>\n    <script>\n        const PLANETS = [\n            { name: \"Saturn\", symbol: \"♄\", color: \"#aaa\" },\n            { name: \"Jupiter\", symbol: \"♃\", color: \"#f90\" },\n            { name: \"Mars\", symbol: \"♂\", color: \"#f33\" },\n            { name: \"Sun\", symbol: \"☉\", color: \"#ff0\" },\n            { name: \"Venus\", symbol: \"♀\", color: \"#f9f\" },\n            { name: \"Mercury\", symbol: \"☿\", color: \"#3ff\" },\n            { name: \"Moon\", symbol: \"☽\", color: \"#fff\" }\n        ];\n\n        // Chaldean Order for hours (Saturday starts with Saturn)\n        const CHALDEAN_ORDER = [0, 1, 2, 3, 4, 5, 6]; // Indices into PLANETS\n\n        // Day Order (Saturday, Sunday, Monday, Tuesday, Wednesday, Thursday, Friday)\n        // Saturday=Saturn, Sunday=Sun, Monday=Moon, Tuesday=Mars, Wednesday=Mercury, Thursday=Jupiter, Friday=Venus\n        const DAY_ORDER = [0, 3, 6, 2, 5, 1, 4];\n\n        document.addEventListener('DOMContentLoaded', async () => {\n            const container = document.getElementById('heptagram-container');\n            const nodes = [];\n\n            // Position planets in heptagram\n            PLANETS.forEach((p, i) => {\n                const node = document.createElement('div');\n                node.className = 'planet-node';\n                node.innerHTML = p.symbol;\n                node.title = p.name;\n                const angle = (i * (360 / 7) - 90) * (Math.PI / 180);\n                const r = 70;\n                node.style.left = (90 + r * Math.cos(angle) - 17) + 'px';\n                node.style.top = (90 + r * Math.sin(angle) - 17) + 'px';\n                container.appendChild(node);\n                nodes.push(node);\n            });\n\n            const game = new LORE.Game({\n                container: '#game-container',\n                prompt: \"{{magenta}}❯{{color_reset}} \",\n                typingSpeed: 20,\n                clearScreenOnNovelLoad: false\n            });\n\n            // Make game globally accessible for debugging if needed\n            window.game = game;\n\n            const updateGUI = () => {\n                const s = game.state;\n                const f = s.flags || {};\n                const turns = f.gameTime || 0;\n                \n                // 1 turn = 15 mins. 4 turns = 1 hour. 96 turns = 1 day.\n                const totalHours = Math.floor(turns / 4);\n                const dayNum = Math.floor(totalHours / 24) + 1;\n                \n                // Day of week (0=Sat, 1=Sun...)\n                const dayIdx = (dayNum - 1) % 7;\n                const dayPlanetIdx = DAY_ORDER[dayIdx];\n                \n                // Hour Planet (Chaldean sequence continues forever)\n                const hourPlanetIdx = totalHours % 7;\n\n                document.getElementById('stat-day-num').querySelector('.stat-value').textContent = dayNum;\n                document.getElementById('stat-day-sym').textContent = PLANETS[dayPlanetIdx].symbol;\n                document.getElementById('stat-day-sym').style.color = PLANETS[dayPlanetIdx].color;\n                document.getElementById('stat-hour-sym').textContent = PLANETS[hourPlanetIdx].symbol;\n                document.getElementById('stat-hour-sym').style.color = PLANETS[hourPlanetIdx].color;\n\n                nodes.forEach((node, i) => {\n                    node.classList.remove('active-day', 'active-hour');\n                    node.style.color = PLANETS[i].color;\n                    node.style.borderColor = 'rgba(255,255,255,0.1)';\n                    node.style.boxShadow = 'none';\n\n                    if (i === dayPlanetIdx) {\n                        node.classList.add('active-day');\n                        node.style.borderColor = PLANETS[i].color;\n                        node.style.boxShadow = `0 0 15px ${PLANETS[i].color}`;\n                    }\n                    if (i === hourPlanetIdx) {\n                        node.classList.add('active-hour');\n                        node.style.textShadow = `0 0 10px ${PLANETS[i].color}`;\n                    }\n                });\n\n                document.getElementById('stat-sanity').textContent = f.sanity ?? 100;\n                document.getElementById('stat-wrath').textContent = f.wrath ?? 0;\n                document.getElementById('stat-loyalty').textContent = f.loyalty ?? 0;\n                \n                document.getElementById('stat-player').textContent = f.playerName ?? \"Desdemona\";\n                document.getElementById('stat-rank').textContent = f.cultRank ?? \"Novice\";\n                document.getElementById('stat-turns').textContent = turns;\n\n                const invList = document.getElementById('inventory-list');\n                invList.innerHTML = s.inventory.length ? s.inventory.map(i => `<li>> ${i.replace(/_/g, ' ').toUpperCase()}</li>`).join('') : '<li>(EMPTY)</li>';\n            };\n\n            // Override processInput to update GUI after every command\n            const originalProcessInput = game.processInput;\n            game.processInput = function(input) {\n                const result = originalProcessInput.call(this, input);\n                updateGUI();\n                return result;\n            };\n\n            // --- Menu Logic ---\n            const menuOverlay = document.getElementById('menu-overlay');\n            const btnOpenMenu = document.getElementById('btn-open-menu');\n            const btnCloseMenu = document.getElementById('btn-close-menu');\n            const tabs = document.querySelectorAll('.menu-tab[data-tab]');\n            const sections = document.querySelectorAll('.menu-section');\n\n            btnOpenMenu.onclick = () => menuOverlay.style.display = 'flex';\n            btnCloseMenu.onclick = () => menuOverlay.style.display = 'none';\n\n            tabs.forEach(tab => {\n                tab.onclick = () => {\n                    tabs.forEach(t => t.classList.remove('active'));\n                    sections.forEach(s => s.classList.remove('active'));\n                    tab.classList.add('active');\n                    document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');\n                };\n            });\n\n            // --- Audio Logic ---\n            let isMuted = false;\n            const btnMute = document.getElementById('btn-mute');\n            btnMute.onclick = () => {\n                isMuted = !isMuted;\n                btnMute.textContent = isMuted ? 'Unmute All Audio' : 'Mute All Audio';\n                // Logic to actually mute audio would go here\n                game.printLine(isMuted ? '{{gray}}[Audio Muted]{{color_reset}}' : '{{gray}}[Audio Unmuted]{{color_reset}}');\n            };\n\n            // --- Save/Load & Logs ---\n            document.getElementById('btn-save-game').onclick = () => {\n                game.saveGame();\n                game.printLine('{{green}}Game state captured in Slot 1.{{color_reset}}');\n            };\n            document.getElementById('btn-load-game').onclick = () => {\n                game.loadGame();\n                updateGUI();\n            };\n\n            document.getElementById('btn-download-logs').onclick = () => {\n                const output = document.getElementById('game-container').querySelector('.lore-output');\n                const logText = output.innerText || output.textContent;\n                const blob = new Blob([logText], { type: 'text/plain' });\n                const url = URL.createObjectURL(blob);\n                const a = document.createElement('a');\n                a.href = url;\n                a.download = `lemegeton_session_${new Date().toISOString().slice(0,10)}.txt`;\n                document.body.appendChild(a);\n                a.click();\n                document.body.removeChild(a);\n                URL.revokeObjectURL(url);\n                game.printLine('{{green}}Session logs downloaded successfully.{{color_reset}}');\n            };\n\n            // --- Settings ---\n            const speedSlider = document.getElementById('setting-text-speed');\n            speedSlider.oninput = () => {\n                game.config.typingSpeed = parseInt(speedSlider.value);\n            };\n\n            const inputPlayerName = document.getElementById('input-player-name');\n            document.getElementById('btn-change-name').onclick = () => {\n                const newName = inputPlayerName.value.trim();\n                if (newName) {\n                    game.state.flags.playerName = newName;\n                    game.printLine(`{{green}}Identity updated: You are now known as ${newName}.{{color_reset}}`);\n                    updateGUI();\n                    inputPlayerName.value = '';\n                }\n            };\n\n            document.getElementById('btn-clear-history').onclick = () => {\n                game.state.history = [];\n                game.printLine('{{gray}}Command history cleared.{{color_reset}}');\n            };\n\n            document.getElementById('btn-reset-game').onclick = () => {\n                if (confirm('Are you sure you want to completely reset? All progress will be lost.')) {\n                    localStorage.removeItem('lore_save_data');\n                    location.reload();\n                }\n            };\n\n            // --- Multiplayer Logic (PeerJS Real-time MUD) ---\n            const multiInit = document.getElementById('multi-init');\n            const multiHosting = document.getElementById('multi-hosting');\n            const serverCodeDisplay = document.getElementById('display-server-code');\n            const btnStopMulti = document.getElementById('btn-stop-multi');\n            const btnLeaveMulti = document.getElementById('btn-leave-multi');\n\n            let peer = null;\n            let connections = []; // For Host: list of all connected clients\n\n            const PEER_CONFIG = {\n                config: {\n                    'iceServers': [\n                        { url: 'stun:stun.l.google.com:19302' },\n                        { url: 'stun:stun1.l.google.com:19302' },\n                        { url: 'stun:stun2.l.google.com:19302' },\n                    ]\n                },\n                debug: 1 // Only errors and warnings\n            };\n\n            window.broadcastMsg = (type, data) => {\n                const msg = {\n                    from: game.state.flags.playerName,\n                    type,\n                    data,\n                    ts: Date.now()\n                };\n                \n                if (game.state.flags.isHost) {\n                    connections.forEach(conn => { if (conn.open) conn.send(msg); });\n                } else if (peer && connections[0] && connections[0].open) {\n                    connections[0].send(msg);\n                }\n            };\n\n            window.handleIncomingMsg = (msg) => {\n                if (msg.from === game.state.flags.playerName) return;\n\n                switch(msg.type) {\n                    case 'say':\n                        game.printLine(`{{green}}${msg.from}${msg.data.prefix}: \"${msg.data.text}\"{{color_reset}}`);\n                        break;\n                    case 'emote':\n                        game.printLine(`{{magenta}}* ${msg.from} ${msg.data.action}{{color_reset}}`);\n                        break;\n                    case 'move':\n                        game.printLine(`{{gray}}[MUD] ${msg.from} moves ${msg.data.dir} to ${msg.data.roomName}{{color_reset}}`);\n                        break;\n                    case 'join':\n                        game.printLine(`{{cyan}}[MUD] ${msg.data.name} has entered the realm.{{color_reset}}`);\n                        break;\n                    case 'leave':\n                        game.printLine(`{{red}}[MUD] ${msg.data.name} has left the realm.{{color_reset}}`);\n                        break;\n                }\n\n                if (game.state.flags.isHost) {\n                    connections.forEach(conn => {\n                        if (conn.peer !== msg.peerId && conn.open) conn.send(msg);\n                    });\n                }\n            };\n\n            window.setupMultiplayer = (isHost, code) => {\n                game.state.flags.isMultiplayer = true;\n                game.state.flags.isHost = isHost;\n                game.state.flags.currentMultiCode = code;\n                \n                game.clearScreen();\n                \n                if (isHost) {\n                    btnStopMulti.style.display = 'block';\n                    btnLeaveMulti.style.display = 'none';\n                    game.state.flags.playerName = game.state.flags.playerName || \"Adept Elara\";\n                    game.printLine(`{{cyan}}System: Global Session [${code}] started. Hosting as ${game.state.flags.playerName}.{{color_reset}}`);\n                } else {\n                    btnStopMulti.style.display = 'none';\n                    btnLeaveMulti.style.display = 'block';\n                    game.state.flags.playerName = game.state.flags.playerName || \"Adept Kael\";\n                    game.printLine(`{{yellow}}System: Connected Globally to [${code}] as ${game.state.flags.playerName}.{{color_reset}}`);\n                    window.broadcastMsg('join', { name: game.state.flags.playerName });\n                }\n\n                // ... [commands and movement remain identical] ...\n                game.registerCommand('emote', {\n                    description: 'Perform an action',\n                    execute: (args) => {\n                        if (args.length === 0) return false;\n                        const action = args.join(' ');\n                        game.printLine(`{{magenta}}* ${game.state.flags.playerName} ${action}{{color_reset}}`);\n                        window.broadcastMsg('emote', { action });\n                        return true;\n                    }\n                });\n                game.registerAlias('me', 'emote');\n\n                game.registerCommand('say', {\n                    description: 'Speak: say <any-text> \"<say-text>\"',\n                    execute: (args) => {\n                        const input = args.join(' ');\n                        const match = input.match(/^(.*?)\\s*\"(.*)\"$/);\n                        if (match) {\n                            const prefix = match[1].trim() ? `(${match[1].trim()})` : '';\n                            const text = match[2].trim();\n                            game.printLine(`{{green}}${game.state.flags.playerName}${prefix}: \"${text}\"{{color_reset}}`);\n                            window.broadcastMsg('say', { prefix, text });\n                        } else {\n                            game.printLine('{{red}}Usage: say <any-text> \"<say-text>\"{{color_reset}}');\n                        }\n                        return true;\n                    }\n                });\n\n                const originalMoveToRoom = game.moveToRoom;\n                game.moveToRoom = function(roomId) {\n                    const oldRoomId = this.state.currentRoom;\n                    const oldRoom = this.world.rooms.get(oldRoomId);\n                    originalMoveToRoom.call(this, roomId);\n                    if (this.state.currentRoom === roomId && oldRoomId !== roomId) {\n                        const newRoom = this.world.rooms.get(roomId);\n                        let dir = \"away\";\n                        if (oldRoom && oldRoom.exits) {\n                            for (const d in oldRoom.exits) if (oldRoom.exits[d] === roomId) { dir = d; break; }\n                        }\n                        window.broadcastMsg('move', { dir, roomName: newRoom.name });\n                    }\n                };\n\n                const currentRoom = game.world.rooms.get(game.state.currentRoom);\n                if (currentRoom && (!currentRoom.characters || !currentRoom.characters.includes('desdemona'))) {\n                    currentRoom.characters = currentRoom.characters || [];\n                    currentRoom.characters.push('desdemona');\n                }\n\n                game.describeRoom();\n                updateGUI();\n            };\n\n            document.getElementById('btn-multi-host').onclick = () => {\n                const code = \"LORE-\" + Math.random().toString(36).substring(2, 8).toUpperCase();\n                game.printLine(`{{gray}}Starting peer server connection...{{color_reset}}`);\n                \n                peer = new Peer(code, PEER_CONFIG);\n                \n                peer.on('open', (id) => {\n                    serverCodeDisplay.textContent = id;\n                    multiInit.style.display = 'none';\n                    multiHosting.style.display = 'block';\n                    window.setupMultiplayer(true, id);\n                });\n\n                peer.on('connection', (conn) => {\n                    connections.push(conn);\n                    conn.on('data', (data) => {\n                        data.peerId = conn.peer;\n                        window.handleIncomingMsg(data);\n                    });\n                    conn.on('close', () => {\n                        connections = connections.filter(c => c !== conn);\n                    });\n                });\n\n                peer.on('error', (err) => {\n                    game.printLine(`{{red}}Multiplayer Error: ${err.type}{{color_reset}}`);\n                    if (err.type === 'unavailable-id') alert('Server code collision. Please try again.');\n                });\n            };\n\n            document.getElementById('btn-multi-join').onclick = () => {\n                const rawCode = prompt('Enter Server Code (e.g., LORE-XXXXXX):');\n                if (!rawCode) return;\n                \n                const code = rawCode.trim().toUpperCase();\n                game.printLine(`{{gray}}Searching for realm [${code}]...{{color_reset}}`);\n                \n                peer = new Peer(undefPEER_CONFIG); // Auto-id for client\n                \n                peer.on('open', () => {\n                    const conn = peer.connect(code, { reliable: true });\n                    conn.on('open', () => {\n                        connections = [conn];\n                        serverCodeDisplay.textContent = code;\n                        multiInit.style.display = 'none';\n                        multiHosting.style.display = 'block';\n                        window.setupMultiplayer(false, code);\n                    });\n                    conn.on('data', (data) => {\n                        window.handleIncomingMsg(data);\n                    });\n                    conn.on('error', (err) => {\n                        alert('Connection error: ' + err);\n                    });\n                    conn.on('close', () => {\n                        alert('Disconnected from realm host.');\n                        location.reload();\n                    });\n                });\n\n                peer.on('error', (err) => {\n                    game.printLine(`{{red}}Connection failed: ${err.type}{{color_reset}}`);\n                });\n            };\n\n            btnStopMulti.onclick = () => {\n                if (peer) {\n                    window.broadcastMsg('leave', { name: game.state.flags.playerName });\n                    peer.destroy();\n                }\n                location.reload();\n            };\n\n            btnLeaveMulti.onclick = () => {\n                if (peer) {\n                    window.broadcastMsg('leave', { name: game.state.flags.playerName });\n                    peer.destroy();\n                }\n                location.reload();\n            };\n\n            try {\n                // Use absolute path logic for GH Pages\n                const novelPath = './lemegeton.js';\n                await game.loadNovel(novelPath);\n                \n                // Force an initial GUI update and room description\n                game.describeRoom();\n                updateGUI();\n            } catch (e) {\n                console.error(\"Game Load Error:\", e);\n            }\n        });\n    </script>\n</body>\n</html>\n"
        }
    ]
}