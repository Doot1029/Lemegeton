{
    "sourceFile": "crtplate.html",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 4,
            "patches": [
                {
                    "date": 1772178229037,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1772178261905,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1576,6 +1576,5 @@\n \t\t}\r\n \r\n \t\trequestAnimationFrame(draw);\r\n \t}\r\n-</script>\r\n-<!-- 8< -- ## GL SHADER STUFF ENDS HERE ## -- -->\n\\ No newline at end of file\n+</script>\n\\ No newline at end of file\n"
                },
                {
                    "date": 1772178356231,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -962,9 +962,9 @@\n \r\n .p8_start_button{\r\n \tcursor:pointer;\r\n \tbackground:url(\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAIAAABMXPacAAAARUlEQVR4Ae3dgQAAAACAoP2pFymSAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACABsCAAAGB4kPcAAAAEHRFWHRMb2RlUE5HADIwMTEwMjIx41m2wQAAAABJRU5ErkJggg==\");\r\n-\t-repeat center;\r\n+\t-repeat: center;\r\n \t-webkit-background-size:cover; -moz-background-size:cover; -o-background-size:cover; background-size:cover;\r\n }\r\n \r\n .button_gfx{\r\n"
                },
                {
                    "date": 1772178395052,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -962,9 +962,9 @@\n \r\n .p8_start_button{\r\n \tcursor:pointer;\r\n \tbackground:url(\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAIAAABMXPacAAAARUlEQVR4Ae3dgQAAAACAoP2pFymSAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACABsCAAAGB4kPcAAAAEHRFWHRMb2RlUE5HADIwMTEwMjIx41m2wQAAAABJRU5ErkJggg==\");\r\n-\t-repeat: center;\r\n+\t-repeat-center;\r\n \t-webkit-background-size:cover; -moz-background-size:cover; -o-background-size:cover; background-size:cover;\r\n }\r\n \r\n .button_gfx{\r\n"
                },
                {
                    "date": 1772178402416,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -962,9 +962,9 @@\n \r\n .p8_start_button{\r\n \tcursor:pointer;\r\n \tbackground:url(\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAIAAABMXPacAAAARUlEQVR4Ae3dgQAAAACAoP2pFymSAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACABsCAAAGB4kPcAAAAEHRFWHRMb2RlUE5HADIwMTEwMjIx41m2wQAAAABJRU5ErkJggg==\");\r\n-\t-repeat-center;\r\n+\t-repeat: center;\r\n \t-webkit-background-size:cover; -moz-background-size:cover; -o-background-size:cover; background-size:cover;\r\n }\r\n \r\n .button_gfx{\r\n"
                }
            ],
            "date": 1772178229037,
            "name": "Commit-0",
            "content": "<html><head>\r\n<title>PICO-8 Cartridge</title>\r\n<meta name=\"viewport\" content=\"width=device-width, user-scalable=no\">\r\n<script type=\"text/javascript\">\r\n\r\n\t// Default shell for PICO-8 0.2.2 (includes @weeble's gamepad mod 1.0)\r\n\t// This file is available under a CC0 license https://creativecommons.org/share-your-work/public-domain/cc0/\r\n\t// (note: \"this file\" does not include any cartridge or cartridge artwork injected into a derivative html file when using the PICO-8 html exporter)\r\n\r\n\t// options\r\n\r\n\t// fullscreen, sound, close button at top when playing on touchscreen\r\n\tvar p8_allow_mobile_menu = true;\r\n\r\n\t// p8_autoplay true to boot the cartridge automatically after page load when possible\r\n\t// if the browser can not create an audio context outside of a user gesture (e.g. on iOS), p8_autoplay has no effect\r\n\tvar p8_autoplay = false;\r\n\r\n\t// When pico8_state is defined, PICO-8 will set .is_paused, .sound_volume and .frame_number each frame \r\n\t// (used for determining button icons)\r\n\tvar pico8_state = [];\r\n\r\n\t// When pico8_buttons is defined, PICO-8 reads each int as a bitfield holding that player's button states\r\n\t// 0x1 left, 0x2 right, 0x4 up, 0x8 right, 0x10 O, 0x20 X, 0x40 menu\r\n\t// (used by p8_update_gamepads)\r\n\tvar pico8_buttons = [0, 0, 0, 0, 0, 0, 0, 0]; // max 8 players\r\n\r\n\t// When pico8_mouse is defined, PICO-8 reads the 3 integers as X, Y and a bitfield for buttons: 0x1 LMB, 0x2 RMB\r\n\tvar pico8_mouse = [];\r\n\r\n\t// used to display number of detected joysticks\r\n\tvar pico8_gamepads = {};\r\n\tpico8_gamepads.count = 0;\r\n\r\n\t// When pico8_gpio is defined, reading and writing to gpio pins will read and write to these values\r\n\tvar pico8_gpio = new Array(128);\r\n\t\r\n\t// When pico8_audio_context context is defined, the html shell (this file) is responsible for creating and managing it.\r\n\t// This makes satisfying browser requirements easier -- e.g. initialising audio from a short script in response to a user action.\r\n\t// Otherwise PICO-8 will try to create and use its own context.\r\n\r\n\tvar pico8_audio_context;\r\n\r\n\r\n\t// menu button and controller graphics\r\n\tp8_gfx_dat={\r\n\t\t\t\"p8b_pause1\": \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAOUlEQVRIx2NgGPbg/8cX/0F46FtAM4vobgHVLRowC6hm0YBbQLFFoxaM4FQ0dHPy0C1Nh26NNugBAAnizNiMfvbGAAAAAElFTkSuQmCC\",\r\n\"p8b_controls\":\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAQ0lEQVRIx2NgGAXEgP8fX/ynBaap4XBLhqcF1IyfYWQBrZLz0LEAlzqqxQFVLcAmT3MLqJqTaW7B4CqLaF4fjIIBBwBL/B2vqtPVIwAAAABJRU5ErkJggg==\",\r\n\"p8b_full\":\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAN0lEQVRIx2NgGPLg/8cX/2mJ6WcBrUJm4CwgOSgGrQVEB8WoBaMWDGMLhm5OHnql6dCt0YY8AAA9oZm+9Z9xQAAAAABJRU5ErkJggg==\",\r\n\"p8b_pause0\":\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAKUlEQVRIx2NgGHbg/8cX/7FhctWNWjBqwagFoxaMWjBqwagF5Fkw5AAAPaGZvsIUtXUAAAAASUVORK5CYII=\",\r\n\"p8b_sound0\":\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAANklEQVRIx2NgGDHg/8cX/5Hx0LEA3cChYwEugwavBcRG4qgFoxYMZwuGfk4efqXp8KnRBj0AAMz7cLDnG4FeAAAAAElFTkSuQmCC\",\r\n\"p8b_sound1\":\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAPUlEQVRIx2NgGDHg/8cX/5Hx0LEA3cChYwEugwhZQLQDqG4BsZFIKMhGLRi1YChbMPRz8vArTYdPjTboAQCSVgpXUWQAMAAAAABJRU5ErkJggg==\",\r\n\"p8b_close\":\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAU0lEQVRIx2NkoDFgpJsF/z+++I8iwS9BkuW49A+cBcRaREgf/Swg1SJi1dHfAkIG4EyOOIJy4Cwg1iJCiWDUAvItGLqpaOjm5KFfmg79Gm3ItioAl+mAGVYIZUUAAAAASUVORK5CYII=\",\r\n\r\n\"controls_left_panel\":\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAYAAAB5fY51AAAEI0lEQVR42u3dMU7DQBCG0Tjam9DTcP8jpEmfswS5iHBhAsLxev/hvQY6pGXyZRTQ+nQCAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHqbHEEtl+vt7hS+fLy/mXHBQqxEi/6aI/AiFW9SnB2BWDkDBAtAsADBAhAsAMECBAtAsAAECxAsAMECECxAsAAEC0CwONJ8tYvrXRAsImK19j0IFsPGSrQQLCJiNV+et7xAT7QQLIaN1dr3ooVgMWysRAvBIipWooVgERUr0UKwiIqVaCFYRMVKtBAsomIlWggWUbESLQSLqFiJFoJFVKxEC8EiKlaihWARFSvRQrDYJSSVfhaCBSBYAIIFCBbAHpoj4Bl/scOGBWDD4lX8iwE2LADBAgQLQLAABAsQLADBAhAsQLAABAtAsADBAhAsAMECBAtAsAAECxAsAMECECxAsAAECxAsAMECECxAsMh1ud7uTsHZVDcZyFo8Yt5sVJ6NyUAaSNEyIymaXwZepIKd4mwoQbAFC0CwAMECECwAwQIEC0CwAAQLECwAwQIQLECwAAQLQLAAwQI4UHME2/10QZq7usyBObBhRQwpmBUb1nADuPbuaUD/p2ezMH+1admwhosVfBcxb2SCJVaIlmAhVoiWYIkVoiVagiVWiJZgiZVYIVqCJVaIlmgJllghWoIlViBagiVWiJZoCZZYIVqCJVYgWoIlViBaggUIlnc0sPELlmghVmIlWKKFWAmWaIFYCZZoIVYIlmghVoIlWiBWgiVaiJVgIVqIlWCJFoiVYIkWYiVYiBZiJViihViJ1XbNEWyL1mMQRYvfvIGJlQ1rmE0LzIoNyyBiDrBhAYIFIFiAYAEIFoBgAYIFIFgAggUIFoBgAQgWIFgAggUgWIBgDc+Nn1D/tdH8YupwgZy5qG4ykKIlVmZDsDjshSlazqQqH7p793Q2CBaAYAGCBSBYAIIFCBaAYAEIFiBYAIIFIFiAYAEIFoBgAYIFIFgAggUIFoBgAQgWIFgAggUgWIBgAQgWwENzBKxZPub9CJ7WjA0LsGFRV+9N5+jNDhsWgGABggUgWACCxW56fgjuA3cEiz9Z/nWwR0iWP8P/YCFYDBstsUKwiIiWWCFYRERLrBAsIqIlVggWEdESKwSLiGiJFYJFRLTECsEiIlpihWARES2xQrCIiJZYIVhEREusECwioiVWCBYx0RIrBIuoaIkVr+YhFHTZtMCGBQgWgGABCBYgWACCBSBYgGABCBaAYAGCBSBYAIIFCBbj2uOR8s6AEbhexgsWYri3SKhKczcXAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMA2n+e0UMDzh3yTAAAAAElFTkSuQmCC\",\r\n\r\n\r\n\"controls_right_panel\":\"data:image/png;base64,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\",\r\n\r\n\t};\r\n\r\n\r\n\t// added 0.2.1: work-around for iOS/Safari running from an iFrame (e.g. from itch.io page):\r\n\t// touch events only register after adding dummy listeners on document.\r\n\r\n\tdocument.addEventListener('touchstart', {});\r\n\tdocument.addEventListener('touchmove', {});\r\n\tdocument.addEventListener('touchend', {});\r\n\r\n\r\n\t// --------------------------------------------------------------------------------------------------------------------------------\r\n\t// pico-8 0.2.2: allow dropping files\r\n\tvar p8_dropped_cart = null;\r\n\tvar p8_dropped_cart_name = \"\";\r\n\tfunction p8_drop_file(e)\r\n\t{\r\n\t\t// console.log(\"@@ dropping file...\");\r\n\t\r\n\t\te.stopPropagation();\r\n\t\te.preventDefault();\r\n\r\n\t\tif (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0])\r\n\t\t{\r\n\t\t\tvar filename = e.dataTransfer.files[0].name;\r\n\t\t\t// read from file\r\n\t\t\treader = new FileReader();\r\n\t\t\treader.onload = function (event) {\r\n\t\t\t\tp8_dropped_cart_name = filename;\r\n\t\t\t\tp8_dropped_cart = reader.result;\r\n\t\t\t\t// data:image/png;base64\r\n\t\t\t\te.stopPropagation();\r\n\t\t\t\te.preventDefault(); \r\n\t\t\t};\r\n\t\t\treader.readAsDataURL(e.dataTransfer.files[0]);\r\n\t\t\tcodo_command = 9; // read directly from p8_dropped_cart with libb64 decoder\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t// read from url (or data url)\r\n\t\t\ttxt = e.dataTransfer.getData('Text');\r\n\t\t\tif (txt){\r\n\t\t\t\tp8_dropped_cart_name = \"untitled.p8.png\";\r\n\t\t\t\tp8_dropped_cart = txt;\r\n\t\t\t\tcodo_command = 9;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\tfunction nop(evt) {\r\n\t\tevt.stopPropagation();\r\n\t\tevt.preventDefault();\r\n\t}\r\n\tfunction dragover(evt) {\r\n\t\tevt.stopPropagation();\r\n\t\tevt.preventDefault();\r\n\t\tModule.pico8DragOver();\r\n\t}\r\n\tfunction dragstop(evt) {\r\n\t\tevt.stopPropagation();\r\n\t\tevt.preventDefault();\r\n\t\tModule.pico8DragStop();\r\n\t}\r\n\t// --------------------------------------------------------------------------------------------------------------------------------\r\n\r\n\r\n\tvar p8_buttons_hash = -1;\r\n\tfunction p8_update_button_icons()\r\n\t{\r\n\t\t// buttons only appear when running\r\n\t\tif (!p8_is_running)\r\n\t\t{\r\n\t\t\trequestAnimationFrame(p8_update_button_icons);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tvar is_fullscreen=(document.fullscreenElement || document.mozFullScreenElement || document.webkitIsFullScreen || document.msFullscreenElement);\r\n\t\t\r\n\t\t// hash based on: pico8_state.sound_volume  pico8_state.is_paused bottom_margin left is_fullscreen p8_touch_detected\r\n\t\tvar hash = 0;\r\n\t\thash = pico8_state.sound_volume;\r\n\t\tif (pico8_state.is_paused) hash += 0x100;\r\n\t\tif (p8_touch_detected)     hash += 0x200;\r\n\t\tif (is_fullscreen)         hash += 0x400;\r\n\r\n\t\tif (p8_buttons_hash == hash)\r\n\t\t{\r\n\t\t\trequestAnimationFrame(p8_update_button_icons);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t\r\n\t\tp8_buttons_hash = hash;\r\n\t\t// console.log(\"@@ updating button icons\");\r\n\r\n\t\tels = document.getElementsByClassName('p8_menu_button');\r\n\t\tfor (i = 0; i < els.length; i++)\r\n\t\t{\r\n\t\t\tel = els[i];\r\n\t\t\tindex = el.id;\t\t\t\r\n\t\t\tif (index == 'p8b_sound') index += (pico8_state.sound_volume == 0 ? \"0\" : \"1\"); // 1 if undefined\r\n\t\t\tif (index == 'p8b_pause') index += (pico8_state.is_paused > 0 ? \"1\" : \"0\");     // 0 if undefined\r\n\r\n\t\t\tnew_str = '<img width=24 height=24 style=\"pointer-events:none\" src=\"'+p8_gfx_dat[index]+'\">';\r\n\t\t\tif (el.innerHTML != new_str)\r\n\t\t\t\tel.innerHTML = new_str;\r\n\r\n\r\n\r\n\r\n\t\t\t// hide all buttons for touch mode (can pause with menu buttons)\r\n\t\t\t\r\n\t\t\tvar is_visible = p8_is_running;\r\n\r\n\t\t\tif ((!p8_touch_detected || !p8_allow_mobile_menu) && el.parentElement.id == \"p8_menu_buttons_touch\")\r\n\t\t\t\tis_visible = false;\r\n\r\n\t\t\tif (p8_touch_detected && el.parentElement.id == \"p8_menu_buttons\")\r\n\t\t\t\tis_visible = false;\r\n\r\n\t\t\tif (is_fullscreen) \r\n\t\t\t\tis_visible = false;\r\n\r\n\t\t\tif (is_visible)\r\n\t\t\t\tel.style.display=\"\";\r\n\t\t\telse\r\n\t\t\t\tel.style.display=\"none\";\r\n\t\t}\r\n\t\trequestAnimationFrame(p8_update_button_icons);\r\n\t}\r\n\r\n\r\n\r\n\tfunction abs(x)\r\n\t{\r\n\t\treturn x < 0 ? -x : x;\r\n\t}\r\n\t\r\n\t// step 0 down 1 drag 2 up (not used)\r\n\tfunction pico8_buttons_event(e, step)\r\n\t{\r\n\t\tif (!p8_is_running) return;\r\n\t\r\n\t\tpico8_buttons[0] = 0;\r\n\r\n\t\tif (step == 2 && typeof(pico8_mouse) !== 'undefined')\r\n\t\t{\r\n\t\t\tpico8_mouse[2] = 0;\r\n\t\t}\r\n\t\t\r\n\t\tvar num = 0;\r\n\t\tif (e.touches) num = e.touches.length;\r\n\r\n\t\tif (num == 0 && typeof(pico8_mouse) !== 'undefined')\r\n\t\t{\r\n\t\t\t//  no active touches: release mouse button from anywhere on page. (maybe redundant? but just in case)\r\n\t\t\tpico8_mouse[2] = 0;\r\n\t\t}\r\n\r\n\t\t\r\n\t\tfor (var i = 0; i < num; i++)\r\n\t\t{\r\n\t\t\tvar touch = e.touches[i];\r\n\t\t\tvar x = touch.clientX;\r\n\t\t\tvar y = touch.clientY;\r\n\t\t\tvar w = window.innerWidth;\r\n\t\t\tvar h = window.innerHeight;\r\n\r\n\t\t\tvar r = Math.min(w,h) / 12;\r\n\t\t\tif (r > 40) r = 40;\r\n\r\n\t\t\t// mouse (0.1.12d)\r\n\r\n\t\t\tvar canvas = document.getElementById(\"canvas\");\r\n\t\t\tif (p8_touch_detected)\r\n\t\t\tif (typeof(pico8_mouse) !== 'undefined')\r\n\t\t\tif (canvas)\r\n\t\t\t{\r\n\t\t\t\tvar rect = canvas.getBoundingClientRect();\r\n\r\n\t\t\t\tif (x >= rect.left && x < rect.right && y >= rect.top && y < rect.bottom)\r\n\t\t\t\t{\r\n\t\t\t\t\tpico8_mouse = [\r\n\t\t\t\t\t\tMath.floor((x - rect.left) * 128 / (rect.right - rect.left)),\r\n\t\t\t\t\t\tMath.floor((y - rect.top) * 128 / (rect.bottom - rect.top)),\r\n\t\t\t\t\t\tstep < 2 ? 1 : 0\r\n\t\t\t\t\t];\r\n\t\t\t\t\t// return; // commented -- blocks overlapping buttons\r\n\t\t\t\t}else\r\n\t\t\t\t{\r\n\t\t\t\t\tpico8_mouse[2] = 0;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\r\n\t\t\t// buttons\r\n\t\t\t\r\n\t\t\tb = 0;\r\n\r\n\t\t\tif (y < h - r*8)\r\n\t\t\t{\r\n\t\t\t\t// no controller buttons up here; includes canvas and menu buttons at top in touch mode\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\te.preventDefault();\r\n\r\n\t\t\t\tif ((y < h - r*6) && y > (h - r*8))\r\n\t\t\t\t{\r\n\t\t\t\t\t// menu button: half as high as X O button\r\n\t\t\t\t\t// stretch across right-hand half above X O buttons\r\n\t\t\t\t\tif (x > w - r*3) \r\n\t\t\t\t\t\tb |= 0x40;\r\n\t\t\t\t}\r\n\t\t\t\telse if (x < w/2 && x < r*6)\r\n\t\t\t\t{\r\n\t\t\t\t\t// stick\r\n\r\n\t\t\t\t\tmask = 0xf; // dpad\r\n\t\t\t\t\tvar cx = 0 + r*3;\r\n\t\t\t\t\tvar cy = h - r*3;\r\n\r\n\t\t\t\t\tdeadzone = r/3;\r\n\t\t\t\t\tvar dx = x - cx;\r\n\t\t\t\t\tvar dy = y - cy;\r\n\r\n\t\t\t\t\tif (abs(dx) > abs(dy) * 0.6) // horizontal \r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tif (dx < -deadzone) b |= 0x1;\r\n\t\t\t\t\t\tif (dx > deadzone) b |= 0x2;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (abs(dy) > abs(dx) * 0.6) // vertical\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tif (dy < -deadzone) b |= 0x4;\r\n\t\t\t\t\t\tif (dy > deadzone) b |= 0x8;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\telse if (x > w - r*6)\r\n\t\t\t\t{\r\n\t\t\t\t\t// button; diagonal split from bottom right corner\r\n\t\t\t\t\r\n\t\t\t\t\tmask = 0x30;\r\n\t\t\t\t\t\r\n\t\t\t\t\t// one or both of [X], [O]\r\n\t\t\t\t\tif ( (h-y) > (w-x) * 0.8) b |= 0x10;\r\n\t\t\t\t\tif ( (w-x) > (h-y) * 0.8) b |= 0x20;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tpico8_buttons[0] |= b;\r\n\t\t\r\n\t\t}\r\n\t}\r\n\r\n\t// p8_update_layout_hash is used to decide when to update layout (expensive especially when part of a heavy page)\r\n\tvar p8_update_layout_hash = -1;\r\n\tvar last_windowed_container_height = 512;\r\n\tvar p8_layout_frames = 0;\r\n\r\n\tfunction p8_update_layout()\r\n\t{\r\n\t\tvar canvas = document.getElementById(\"canvas\");\r\n\t\tvar p8_playarea = document.getElementById(\"p8_playarea\");\r\n\t\tvar p8_container = document.getElementById(\"p8_container\");\r\n\t\tvar p8_frame = document.getElementById(\"p8_frame\");\r\n\t\tvar csize = 512;\r\n\t\tvar margin_top = 0;\r\n\t\tvar margin_left = 0;\r\n\r\n\t\t// page didn't load yet? first call should be after p8_frame is created so that layout doesn't jump around.\r\n\t\tif (!canvas || !p8_playarea || !p8_container || !p8_frame)\r\n\t\t{\r\n\t\t\tp8_update_layout_hash = -1;\r\n\t\t\trequestAnimationFrame(p8_update_layout);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tp8_layout_frames ++;\r\n\r\n\t\t// assumes frame doesn't have padding\r\n\t\t\r\n\t\tvar is_fullscreen=(document.fullscreenElement || document.mozFullScreenElement || document.webkitIsFullScreen || document.msFullscreenElement);\r\n\t\tvar frame_width = p8_frame.offsetWidth;\r\n\t\tvar frame_height = p8_frame.offsetHeight;\r\n\r\n\t\tif (is_fullscreen)\r\n\t\t{\r\n\t\t\t// same as window\r\n\t\t\tframe_width = window.innerWidth;\r\n\t\t\tframe_height = window.innerHeight;\r\n\t\t}\r\n\t\telse{\r\n\t\t\t// never larger than window  // (happens when address bar is down in portraight mode on phone)\r\n\t\t\tframe_width  = Math.min(frame_width, window.innerWidth);\r\n\t\t\tframe_height = Math.min(frame_height, window.innerHeight);\r\n\t\t}\r\n\r\n\t\t// as big as will fit in a frame..\r\n\t\tcsize =  Math.min(frame_width,frame_height);\r\n\r\n\t\t// .. but never more than 2/3 of longest side for touch (e.g. leave space for controls on iPad)\r\n\t\tif (p8_touch_detected && p8_is_running)\r\n\t\t{\r\n\t\t\tvar longest_side = Math.max(window.innerWidth,window.innerHeight);\r\n\t\t\tcsize = Math.min(csize, longest_side * 2/3);\r\n\t\t}\r\n\r\n\t\t// pixel perfect: quantize to closest multiple of 128\r\n\t\t// only when large display (desktop)\r\n\t\tif (frame_width >= 512 && frame_height >= 512)\r\n\t\t{\r\n\t\t\tcsize = (csize+1) & ~0x7f;\r\n\t\t}\r\n\r\n\t\t// csize should never be higher than parent frame\r\n\t\t// (otherwise stretched large when fullscreen and then return)\r\n\t\tif (!is_fullscreen && p8_frame) \r\n\t\t\tcsize = Math.min(csize, last_windowed_container_height); // p8_frame_0 parent\r\n\t\t\r\n\r\n\t\tif (is_fullscreen)\r\n\t\t{\r\n\t\t\t// always center horizontally\r\n\t\t\tmargin_left = (frame_width - csize)/2;\r\n\r\n\t\t\tif (p8_touch_detected)\r\n\t\t\t{\r\n\t\t\t\tif (window.innerWidth < window.innerHeight)\r\n\t\t\t\t{\r\n\t\t\t\t\t// portrait: keep at y=40 (avoid rounded top corners / camera nub thing etc.)\r\n\t\t\t\t\tmargin_top = Math.min(40, frame_height - csize);\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t// landscape: put a little above vertical center\r\n\t\t\t\t\tmargin_top = (frame_height - csize)/4;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse{\r\n\t\t\t\t// non-touch: center vertically\r\n\t\t\t\tmargin_top = (frame_height - csize)/2;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// skip if relevant state has not changed\r\n\r\n\t\tvar update_hash = csize + margin_top * 1000.3 + margin_left * 0.001 + frame_width * 333.33 + frame_height * 772.15134;\r\n\t\tif (is_fullscreen) update_hash += 0.1237;\r\n\r\n\t\t// unexpected things can happen in the first few seconds, so just keep re-calculating layout. wasm version breaks layout otherwise.\r\n\t\t// also: bonus refresh at 5, 8 seconds just in case ._.\r\n\t\tif (p8_layout_frames < 180 || p8_layout_frames == 60*5 || p8_layout_frames == 60*8 )\r\n\t\t\tupdate_hash = p8_layout_frames;\r\n\r\n\t\tif (!is_fullscreen) // fullscreen: update every frame for safety. should be cheap!\r\n\t\tif (!p8_touch_detected) // mobile: update every frame because nothing can be trusted\r\n\t\tif (p8_update_layout_hash == update_hash)\r\n\t\t{\r\n\t\t\t//console.log(\"p8_update_layout(): skipping\");\r\n\t\t\trequestAnimationFrame(p8_update_layout);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tp8_update_layout_hash = update_hash;\r\n\r\n\t\t// record this for returning to original size after fullscreen pushes out container height (argh)\r\n\t\tif (!is_fullscreen && p8_frame)\r\n\t\t\tlast_windowed_container_height = p8_frame.parentNode.parentNode.offsetHeight;\r\n\t\t\r\n\r\n\t\t// mobile in portrait mode: put screen at top (w / a little extra space for fullscreen button if needed)\r\n\t\t// (don't cart too about buttons overlapping screen)\r\n\t\tif (p8_touch_detected && p8_is_running && document.body.clientWidth < document.body.clientHeight)\r\n\t\t\tp8_playarea.style.marginTop = p8_allow_mobile_menu ? 32 : 8;\r\n\t\telse if (p8_touch_detected && p8_is_running) // landscape: slightly above vertical center (only relevant for iPad / highres devices)\r\n\t\t\tp8_playarea.style.marginTop = (document.body.clientHeight - csize) / 4;\r\n\t\telse\r\n\t\t\tp8_playarea.style.marginTop = \"\";\r\n\r\n\t\tcanvas.style.width = csize;\r\n\t\tcanvas.style.height = csize;\r\n\r\n\t\t// to do: this should just happen from css layout\r\n\t\tcanvas.style.marginLeft = margin_left;\r\n\t\tcanvas.style.marginTop = margin_top;\r\n\r\n\t\tp8_container.style.width = csize;\r\n\t\tp8_container.style.height = csize;\r\n\r\n\t\t// set menu buttons position to bottom right\r\n\t\tel = document.getElementById(\"p8_menu_buttons\");\r\n\t\tel.style.marginTop = csize - el.offsetHeight;\r\n\r\n\t\tif (p8_touch_detected && p8_is_running)\r\n\t\t{\r\n\t\t\t// turn off pointer events to prevent double-tap zoom etc (works on Android)\r\n\t\t\t// don't want this for desktop because breaks mouse input & click-to-focus when using codo_textarea\r\n\t\t\tcanvas.style.pointerEvents = \"none\";\r\n\r\n\t\t\tp8_container.style.marginTop = \"0px\";\r\n\r\n\t\t\t// buttons\r\n\t\t\t\r\n\t\t\t// same as touch event handling\r\n\t\t\tvar w = window.innerWidth;\r\n\t\t\tvar h = window.innerHeight;\r\n\t\t\tvar r = Math.min(w,h) / 12;\r\n\r\n\t\t\tif (r > 40) r = 40;\r\n\r\n\t\t\tel = document.getElementById(\"controls_right_panel\");\r\n\t\t\tel.style.left = w-r*6;\r\n\t\t\tel.style.top = h-r*7;\r\n\t\t\tel.style.width = r*6;\r\n\t\t\tel.style.height = r*7;\r\n\t\t\tif (el.getAttribute(\"src\") != p8_gfx_dat[\"controls_right_panel\"]) // optimisation: avoid reload? (browser should handle though)\r\n\t\t\t\tel.setAttribute(\"src\", p8_gfx_dat[\"controls_right_panel\"]);\r\n\r\n\t\t\tel = document.getElementById(\"controls_left_panel\");\r\n\t\t\tel.style.left = 0;\r\n\t\t\tel.style.top = h-r*6;\r\n\t\t\tel.style.width = r*6;\r\n\t\t\tel.style.height = r*6;\r\n\t\t\tif (el.getAttribute(\"src\") != p8_gfx_dat[\"controls_left_panel\"]) // optimisation: avoid reload? (browser should handle though)\r\n\t\t\t\tel.setAttribute(\"src\", p8_gfx_dat[\"controls_left_panel\"]);\r\n\t\t\t\r\n\t\t\t// scroll to cart (commented; was a failed attempt to prevent scroll-on-drag on some browsers)\r\n\t\t\t// p8_frame.scrollIntoView(true);\r\n\r\n\t\t\tdocument.getElementById(\"touch_controls_gfx\").style.display=\"table\";\r\n\t\t\tdocument.getElementById(\"touch_controls_background\").style.display=\"table\";\r\n\r\n\t\t}\r\n\t\telse{\r\n\t\t\tdocument.getElementById(\"touch_controls_gfx\").style.display=\"none\";\r\n\t\t\tdocument.getElementById(\"touch_controls_background\").style.display=\"none\";\r\n\t\t}\r\n\r\n\t\tif (!p8_is_running)\r\n\t\t{\r\n\t\t\tp8_playarea.style.display=\"none\";\r\n\t\t\tp8_container.style.display=\"flex\";\r\n\t\t\tp8_container.style.marginTop=\"auto\";\r\n\r\n\t\t\tel = document.getElementById(\"p8_start_button\");\r\n\t\t\tif (el) el.style.display=\"flex\";\r\n\t\t}\r\n\t\trequestAnimationFrame(p8_update_layout);\r\n\t}\r\n\r\n\r\n\tvar p8_touch_detected = false;\r\n\taddEventListener(\"touchstart\", function(event)\r\n\t{\r\n\t\tp8_touch_detected = true;\r\n\r\n\t\t// hide codo_textarea -- clipboard support on mobile is not feasible\r\n\t\tel = document.getElementById(\"codo_textarea\");\r\n\t\tif (el && el.style.display != \"none\"){\r\n\t\t\tel.style.display=\"none\";\r\n\t\t}\r\n\r\n\t},  {passive: true});\r\n\r\n\tfunction p8_create_audio_context()\r\n\t{\r\n\t\tif (pico8_audio_context) \r\n\t\t{\r\n\t\t\ttry {\r\n\t\t\t\tpico8_audio_context.resume();\r\n\t\t\t}\r\n\t\t\tcatch(err) {\r\n\t\t\t\tconsole.log(\"** pico8_audio_context.resume() failed\");\r\n\t\t\t}\t\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tvar webAudioAPI = window.AudioContext || window.webkitAudioContext || window.mozAudioContext || window.oAudioContext || window.msAudioContext;\t\t\t\r\n\t\tif (webAudioAPI)\r\n\t\t{\r\n\t\t\tpico8_audio_context = new webAudioAPI;\r\n\r\n\t\t\t// wake up iOS\r\n\t\t\tif (pico8_audio_context)\r\n\t\t\t{\r\n\t\t\t\ttry {\r\n\t\t\t\t\tvar dummy_source_sfx = pico8_audio_context.createBufferSource();\r\n\t\t\t\t\tdummy_source_sfx.buffer = pico8_audio_context.createBuffer(1, 1, 22050); // dummy\r\n\t\t\t\t\tdummy_source_sfx.connect(pico8_audio_context.destination);\r\n\t\t\t\t\tdummy_source_sfx.start(1, 0.25); // gives InvalidStateError -- why? hasn't been played before \r\n\t\t\t\t\t//dummy_source_sfx.noteOn(0); // deleteme\r\n\t\t\t\t}\r\n\t\t\t\tcatch(err) {\r\n\t\t\t\t\tconsole.log(\"** dummy_source_sfx.start(1, 0.25) failed\");\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tfunction p8_close_cart()\r\n\t{\r\n\t\t// just reload page! used for touch buttons -- hard to roll back state \r\n\t\twindow.location.hash = \"\"; // triggers reload\r\n\t}\r\n\r\n\tvar p8_is_running = false;\r\n\tvar p8_script = null;\r\n\tvar Module = null;\r\n\tfunction p8_run_cart()\r\n\t{\r\n\t\tif (p8_is_running) return;\r\n\t\tp8_is_running = true;\r\n\r\n\t\t// touch: hide everything except p8_frame_0\r\n\t\tif (p8_touch_detected)\r\n\t\t{\r\n\t\t\tel = document.getElementById(\"body_0\");\r\n\t\t\tel2 = document.getElementById(\"p8_frame_0\");\r\n\t\t\tif (el && el2)\r\n\t\t\t{\r\n\t\t\t\tel.style.display=\"none\";\r\n\t\t\t\tel.parentNode.appendChild(el2);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// create audio context and wake it up (for iOS -- needs happen inside touch event)\t\t\r\n\t\tp8_create_audio_context();\r\n\r\n\t\t// show touch elements\r\n\t\tels = document.getElementsByClassName('p8_controller_area');\r\n\t\tfor (i = 0; i < els.length; i++)\r\n\t\t\tels[i].style.display=\"\";\r\n\r\n\r\n\t\t// install touch events. These also serve to block scrolling / pinching / zooming on phones when p8_is_running\r\n\t\t\t// moved event.preventDefault(); calls into pico8_buttons_event() (want to let top buttons pass through)\r\n\t\taddEventListener(\"touchstart\", function(event){ pico8_buttons_event(event, 0); }, {passive: false});\r\n\t\taddEventListener(\"touchmove\",  function(event){ pico8_buttons_event(event, 1); }, {passive: false});\r\n\t\taddEventListener(\"touchend\",   function(event){ pico8_buttons_event(event, 2); }, {passive: false});\r\n\r\n\r\n\t\t// load and run script\r\n\t\te = document.createElement(\"script\");\r\n\t\tp8_script = e;\r\n\t\te.onload = function(){\r\n\t\t\t\r\n\t\t\t// show canvas / menu buttons only after loading\r\n\t\t\tel = document.getElementById(\"p8_playarea\");\r\n\t\t\tif (el) el.style.display=\"table\";\r\n\r\n\t\t\tif (typeof(p8_update_layout_hash) !== 'undefined')\r\n\t\t\t\tp8_update_layout_hash = -77;\r\n\t\t\tif (typeof(p8_buttons_hash) !== 'undefined')\r\n\t\t\t\tp8_buttons_hash = -33;\r\n\r\n\t\t\tvar canvas = document.getElementById(\"canvas\");\r\n\t\t\tp8_crt_effect_init(canvas);\r\n\r\n\t\t\t// install drag&drop listeners\r\n\t\t\t/*{\r\n\t\t\t\tvar canvas = document.getElementById(\"canvas\");\r\n\t\t\t\tif (canvas)\r\n\t\t\t\t{\r\n\t\t\t\t\tcanvas.addEventListener('dragenter', dragover, false);\r\n\t\t\t\t\tcanvas.addEventListener('dragover', dragover, false);\r\n\t\t\t\t\tcanvas.addEventListener('dragleave', dragstop, false);\r\n\t\t\t\t\tcanvas.addEventListener('drop', nop, false);\r\n\t\t\t\t\tcanvas.addEventListener('drop', p8_drop_file, false);\r\n\t\t\t\t}\r\n\t\t\t}*/\r\n\t\t}\r\n\t\te.type = \"application/javascript\";\r\n\t\te.src = \"##js_file##\";\r\n\t\te.id = \"e_script\";\r\n\t\t\r\n\t\tdocument.body.appendChild(e); // load and run\r\n\r\n\t\t// hide start button and show canvas / menu buttons. hide start button\r\n\t\tel = document.getElementById(\"p8_start_button\");\r\n\t\tif (el) el.style.display=\"none\";\r\n\r\n\t\t// add #playing for touchscreen devices (allows back button to close)\r\n\t\t// X button can also be used to trigger this \r\n\t\tif (p8_touch_detected)\r\n\t\t{\r\n\t\t\twindow.location.hash = \"#playing\";\r\n\t\t\twindow.onhashchange = function()\r\n\t\t\t{\r\n\t\t\t\tif (window.location.hash.search(\"playing\") < 0)\r\n\t\t\t\t\twindow.location.reload();\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t}\r\n\r\n\t\r\n\t\t// Gamepad code\r\n\t\r\n\tvar P8_BUTTON_O = {action:'button', code: 0x10};\r\n\tvar P8_BUTTON_X = {action:'button', code: 0x20};\r\n\tvar P8_DPAD_LEFT = {action:'button', code: 0x1};\r\n\tvar P8_DPAD_RIGHT = {action:'button', code: 0x2};\r\n\tvar P8_DPAD_UP = {action:'button', code: 0x4};\r\n\tvar P8_DPAD_DOWN = {action:'button', code: 0x8};\r\n\tvar P8_MENU = {action:'menu'};\r\n\tvar P8_NO_ACTION = {action:'none'};\r\n\r\n\tvar P8_BUTTON_MAPPING = [\r\n\t\t// ref: https://w3c.github.io/gamepad/#remapping\r\n\t\tP8_BUTTON_O,          // Bottom face button\r\n\t\tP8_BUTTON_X,          // Right face button\r\n\t\tP8_BUTTON_X,          // Left face button\r\n\t\tP8_BUTTON_O,          // Top face button\r\n\t\tP8_NO_ACTION,         // Near left shoulder button (L1)\r\n\t\tP8_NO_ACTION,         // Near right shoulder button (R1)\r\n\t\tP8_NO_ACTION,         // Far left shoulder button (L2)\r\n\t\tP8_NO_ACTION,         // Far right shoulder button (R2)\r\n\t\tP8_MENU,              // Left auxiliary button (select)\r\n\t\tP8_MENU,              // Right auxiliary button (start)\r\n\t\tP8_NO_ACTION,         // Left stick button\r\n\t\tP8_NO_ACTION,         // Right stick button\r\n\t\tP8_DPAD_UP,           // Dpad up\r\n\t\tP8_DPAD_DOWN,         // Dpad down\r\n\t\tP8_DPAD_LEFT,         // Dpad left\r\n\t\tP8_DPAD_RIGHT,        // Dpad right\r\n\t];\r\n\r\n\t// Track which player is controller by each gamepad. Gamepad index i controls the\r\n\t// player with index pico8_gamepads_mapping[i]. Gamepads with null player are\r\n\t// currently unassigned - they get assigned to a player when a button is pressed.\r\n\tvar pico8_gamepads_mapping = [];\r\n\r\n\tfunction p8_unassign_gamepad(gamepad_index) {\r\n\t\tif (pico8_gamepads_mapping[gamepad_index] == null) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tpico8_buttons[pico8_gamepads_mapping[gamepad_index]] = 0;\r\n\t\tpico8_gamepads_mapping[gamepad_index] = null;\r\n\t}\r\n\r\n\r\n\tfunction p8_first_player_without_gamepad(max_players) {\r\n\t\tvar allocated_players = pico8_gamepads_mapping.filter(function(x) { return x != null; });\r\n\t\tvar sorted_players = Array.from(allocated_players).sort();\r\n\t\tfor (var desired = 0; desired < sorted_players.length && desired < max_players; ++desired) {\r\n\t\t\tif (desired != sorted_players[desired]) {\r\n\t\t\t\treturn desired;\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (sorted_players.length < max_players) {\r\n\t\t\treturn sorted_players.length;\r\n\t\t}\r\n\t\treturn null;\r\n\t}\r\n\r\n\tfunction p8_assign_gamepad_to_player(gamepad_index, player_index) {\r\n\t\tp8_unassign_gamepad(gamepad_index);\r\n\t\tpico8_gamepads_mapping[gamepad_index] = player_index;\r\n\t}\r\n\r\n\r\n\r\n\tfunction p8_convert_standard_gamepad_to_button_state(gamepad, axis_threshold, button_threshold) {\r\n\t\t// Given a gamepad object, return:\r\n\t\t// {\r\n\t\t//     button_state: the binary encoded Pico 8 button state\r\n\t\t//     menu_button: true if any menu-mapped button was pressed\r\n\t\t//     any_button: true if any button was pressed, including d-pad\r\n\t\t//         buttons and unmapped buttons\r\n\t\t// }\r\n\t\tif (!gamepad || !gamepad.axes || !gamepad.buttons) {\r\n\t\t\treturn {\r\n\t\t\t\tbutton_state: 0,\r\n\t\t\t\tmenu_button: false,\r\n\t\t\t\tany_button: false\r\n\t\t\t};\r\n\t\t}\r\n\t\tfunction button_state_from_axis(axis, low_state, high_state, default_state) {\r\n\t\t\tif (axis && axis < -axis_threshold) return low_state;\r\n\t\t\tif (axis && axis > axis_threshold) return high_state;\r\n\t\t\treturn default_state;\r\n\t\t}\r\n\t\tvar axes_actions = [\r\n\t\t\tbutton_state_from_axis(gamepad.axes[0], P8_DPAD_LEFT, P8_DPAD_RIGHT, P8_NO_ACTION),\r\n\t\t\tbutton_state_from_axis(gamepad.axes[1], P8_DPAD_UP, P8_DPAD_DOWN, P8_NO_ACTION),\r\n\t\t];\r\n\r\n\t\tvar button_actions = gamepad.buttons.map(function (button, index) {\r\n\t\t\tvar pressed = button.value > button_threshold || button.pressed;\r\n\t\t\tif (!pressed) return P8_NO_ACTION;\r\n\t\t\treturn P8_BUTTON_MAPPING[index] || P8_NO_ACTION;\r\n\t\t});\r\n\r\n\t\tvar all_actions = axes_actions.concat(button_actions);\r\n\t\t\r\n\t\tvar menu_button = button_actions.some(function (action) { return action.action == 'menu'; });\r\n\t\tvar button_state = (all_actions\r\n\t\t\t.filter(function (a) { return a.action == 'button'; })\r\n\t\t\t.map(function (a) { return a.code; })\r\n\t\t\t.reduce(function (result, code) { return result | code; }, 0)\r\n\t\t);\r\n\t\tvar any_button = gamepad.buttons.some(function (button) {\r\n\t\t\treturn button.value > button_threshold || button.pressed;\r\n\t\t});\r\n\r\n\t\tany_button |= button_state; //jww: include axes 0,1 as might be first intended action\r\n\r\n\t\treturn {\r\n\t\t\tbutton_state,\r\n\t\t\tmenu_button,\r\n\t\t\tany_button\r\n\t\t};\r\n\t}\r\n\r\n\t// jww: pico-8 0.2.1 version for unmapped gamepads, following p8_convert_standard_gamepad_to_button_state\r\n\t// axes 0,1 & buttons 0,1,2,3 are reasonably safe. don't try to read dpad.\r\n\t// menu buttons are unpredictable, but use 6..8 anyway (better to have a weird menu button than none)\r\n\r\n\tfunction p8_convert_unmapped_gamepad_to_button_state(gamepad, axis_threshold, button_threshold) {\r\n\r\n\t\tif (!gamepad || !gamepad.axes || !gamepad.buttons) {\r\n\t\t\treturn {\r\n\t\t\t\tbutton_state: 0,\r\n\t\t\t\tmenu_button: false,\r\n\t\t\t\tany_button: false\r\n\t\t\t};\r\n\t\t}\r\n\r\n\t\tvar button_state = 0;\r\n\r\n\t\tif (gamepad.axes[0] && gamepad.axes[0] < -axis_threshold) button_state |= 0x1;\r\n\t\tif (gamepad.axes[0] && gamepad.axes[0] > axis_threshold)  button_state |= 0x2;\r\n\t\tif (gamepad.axes[1] && gamepad.axes[1] < -axis_threshold) button_state |= 0x4;\r\n\t\tif (gamepad.axes[1] && gamepad.axes[1] > axis_threshold)  button_state |= 0x8;\r\n\r\n\t\t// buttons: first 4 taken to be O/X, 6..8 taken to be menu button\r\n\r\n\t\tfor (j = 0; j < gamepad.buttons.length; j++)\r\n\t\tif (gamepad.buttons[j].value > 0 || gamepad.buttons[j].pressed)\r\n\t\t{\r\n\t\t\tif (j < 4)\r\n\t\t\t\tbutton_state |= (0x10 << (((j+1)/2)&1)); // 0 1 1 0 -- A,X -> O,X on xbox360\r\n\t\t\telse if (j >= 6 && j <= 8)\r\n\t\t\t\tbutton_state |= 0x40;\r\n\t\t}\r\n\r\n\t\tvar menu_button = button_state & 0x40;\r\n\r\n\t\tvar any_button = gamepad.buttons.some(function (button) {\r\n\t\t\treturn button.value > button_threshold || button.pressed;\r\n\t\t});\r\n\r\n\t\tany_button |= button_state; //jww: include axes 0,1 as might be first intended action\r\n\t\t\r\n\t\treturn {\r\n\t\t\tbutton_state,\r\n\t\t\tmenu_button,\r\n\t\t\tany_button\r\n\t\t};\r\n\t}\r\n\r\n\t\r\n\t// gamepad  https://developer.mozilla.org/en-US/docs/Web/API/Gamepad_API/Using_the_Gamepad_API\r\n\t// (sets bits in pico8_buttons[])\r\n\tfunction p8_update_gamepads() {\r\n\t\tvar axis_threshold = 0.3;\r\n\t\tvar button_threshold = 0.5; // Should be unnecessary, we should be able to trust .pressed\r\n\t\tvar max_players = 8;\r\n\t\tvar gps = navigator.getGamepads() || navigator.webkitGetGamepads();\r\n\r\n\t\tif (!gps) return;\r\n\r\n\t\t// In Chrome, gps is iterable but it's not an array.\r\n\t\tgps = Array.from(gps);\r\n\r\n\t\tpico8_gamepads.count = gps.length;\r\n\t\twhile (gps.length > pico8_gamepads_mapping.length) {\r\n\t\t    pico8_gamepads_mapping.push(null);\r\n\t\t}\r\n\r\n\t\tvar menu_button = false;\r\n\t\tvar gamepad_states = gps.map(function (gp) {\r\n\t\t\treturn (gp && gp.mapping == \"standard\") ?\r\n\t\t\t\tp8_convert_standard_gamepad_to_button_state(gp, axis_threshold, button_threshold) :\r\n\t\t\t\tp8_convert_unmapped_gamepad_to_button_state(gp, axis_threshold, button_threshold);\r\n\t\t});\r\n\r\n\t\t// Unassign disconnected gamepads.\r\n\t\t// gps.forEach(function (gp, i) { if (gp && !gp.connected) { p8_unassign_gamepad(i); }});\r\n\t\tgps.forEach(function (gp, i) { if (!gp || !gp.connected) { p8_unassign_gamepad(i); }}); // https://www.lexaloffle.com/bbs/?pid=87132#p\r\n\r\n\r\n\t\t// Assign unassigned gamepads when any button is pressed.\r\n\t\tgamepad_states.forEach(function (state, i) {\r\n\t\t\tif (state.any_button && pico8_gamepads_mapping[i] == null) {\r\n\t\t\t\tvar first_free_player = p8_first_player_without_gamepad(max_players);\r\n\t\t\t\tp8_assign_gamepad_to_player(i, first_free_player);\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\t// Update pico8_buttons array.\r\n\t\tgamepad_states.forEach(function (gamepad_state, i) {\r\n\t\t\tif (pico8_gamepads_mapping[i] != null) {\r\n\t\t\t\tpico8_buttons[pico8_gamepads_mapping[i]] = gamepad_state.button_state;\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\t// Update menu button.\r\n\t\t// Pico 8 only recognises the menu button on the first player, so we\r\n\t\t// press it when any gamepad has pressed a button mapped to menu.\r\n\t\tif (gamepad_states.some(function (state) { return state.menu_button; })) {\r\n\t\t\tpico8_buttons[0] |= 0x40;\r\n\t\t}\r\n\r\n\t\trequestAnimationFrame(p8_update_gamepads);\r\n\t}\r\n\trequestAnimationFrame(p8_update_gamepads);\r\n\r\n\t// End of gamepad code\r\n\r\n\r\n\t// key blocker. prevent cursor keys from scrolling page while playing cart.\r\n\t// also don't act on M, R so that can mute / reset cart\r\n\tdocument.addEventListener('keydown',\r\n\tfunction (event) {\r\n\t\tevent = event || window.event;\r\n\t\tif (!p8_is_running) return;\r\n\t\tif (pico8_state.has_focus == 1)\r\n\t\t\tif ([32, 37, 38, 39, 40, 77, 82, 80, 9].indexOf(event.keyCode) > -1)       // block cursors, M R P, tab\r\n\t\t\t\tif (event.preventDefault) event.preventDefault();\r\n\t},{passive: false});\r\n\r\n\t// when using codo_textarea to determine focus, need to explicitly hand focus back when clicking a p8_menu_button\r\n\tfunction p8_give_focus()\r\n\t{\r\n\t\tel = (typeof codo_textarea === 'undefined') ? document.getElementById(\"codo_textarea\") : codo_textarea;\r\n\t\tif (el)\r\n\t\t{\r\n\t\t\tel.focus();\r\n\t\t\tel.select();\r\n\t\t}\r\n\t}\r\n\r\n\tfunction p8_request_fullscreen() {\r\n\r\n\t\tvar is_fullscreen=(document.fullscreenElement || document.mozFullScreenElement || document.webkitIsFullScreen || document.msFullscreenElement);\r\n\r\n\t\tif (is_fullscreen)\r\n\t\t{\r\n\t\t\t if (document.exitFullscreen) {\r\n\t\t        document.exitFullscreen();\r\n\t\t    } else if (document.webkitExitFullscreen) {\r\n\t\t        document.webkitExitFullscreen();\r\n\t\t    } else if (document.mozCancelFullScreen) {\r\n\t\t        document.mozCancelFullScreen();\r\n\t\t    } else if (document.msExitFullscreen) {\r\n\t\t        document.msExitFullscreen();\r\n\t\t    }\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t\r\n\t\tvar el = document.getElementById(\"p8_playarea\");\r\n\r\n\t\tif ( el.requestFullscreen ) {\r\n\t\t\tel.requestFullscreen();\r\n\t\t} else if ( el.mozRequestFullScreen ) {\r\n\t\t\tel.mozRequestFullScreen();\r\n\t\t} else if ( el.webkitRequestFullScreen ) {\r\n\t\t\tel.webkitRequestFullScreen( Element.ALLOW_KEYBOARD_INPUT );\r\n\t\t}\r\n\t}\r\n\r\n</script>\r\n\r\n<STYLE TYPE=\"text/css\">\r\n<!--\r\n.p8_menu_button{\r\n\topacity:0.3;\r\n\tpadding:4px;\r\n\tdisplay:table;\r\n\twidth:24px;\r\n\theight:24px;\r\n\tfloat:right;\r\n}\r\n\r\n@media screen and (min-width:512px) {\r\n\t.p8_menu_button{\r\n\t\twidth:24px; margin-left:12px; margin-bottom:8px;\r\n\t}\r\n}\r\n.p8_menu_button:hover{\r\n\topacity:1.0;\r\n\tcursor:pointer;\r\n}\r\n\r\ncanvas{\r\n    image-rendering: optimizeSpeed;\r\n    image-rendering: -moz-crisp-edges;\r\n    image-rendering: -webkit-optimize-contrast;\r\n    image-rendering: optimize-contrast;\r\n    image-rendering: pixelated;\r\n    -ms-interpolation-mode: nearest-neighbor;\r\n\tborder: 0px;\r\n\tcursor: none;\r\n}\r\n\r\n\r\n.p8_start_button{\r\n\tcursor:pointer;\r\n\tbackground:url(\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAIAAABMXPacAAAARUlEQVR4Ae3dgQAAAACAoP2pFymSAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACABsCAAAGB4kPcAAAAEHRFWHRMb2RlUE5HADIwMTEwMjIx41m2wQAAAABJRU5ErkJggg==\");\r\n\t-repeat center;\r\n\t-webkit-background-size:cover; -moz-background-size:cover; -o-background-size:cover; background-size:cover;\r\n}\r\n\r\n.button_gfx{\r\n\tstroke-width:2;\r\n\tstroke: #ffffff;\r\n\tstroke-opacity:0.4;\r\n\tfill-opacity:0.2;\r\n\tfill:black;\r\n}\r\n\r\n.button_gfx_icon{\r\n\tstroke-width:3;\r\n\tstroke: #909090;\r\n\tstroke-opacity:0.7;\r\n\tfill:none;\r\n}\r\n\r\n-->\r\n</STYLE>\r\n\r\n</head>\r\n\r\n<body style=\"padding:0px; margin:0px; background-color:#222; color:#ccc\">\r\n<div id=\"body_0\"> <!-- hide this when playing in mobile (p8_touch_detected) so that elements don't affect layout -->\r\n\r\n\r\n<!-- Add any content above the cart here -->\r\n\r\n\r\n<div id=\"p8_frame_0\" style=\"max-width:800px; max-height:800px; margin:auto;\"> <!-- double function: limit size, and display only this div for touch devices -->\r\n<div id=\"p8_frame\" style=\"display:flex; width:100%; max-width:95vw; height:100vw; max-height:95vh; margin:auto;\">\r\n\r\n\t<div id=\"p8_menu_buttons_touch\" style=\"position:absolute; width:100%; z-index:10; left:0px;\">\r\n\t\t<div class=\"p8_menu_button\" id=\"p8b_full\"  style=\"float:left;margin-left:10px\" onClick=\"p8_give_focus(); p8_request_fullscreen();\"></div>\r\n\t\t<div class=\"p8_menu_button\" id=\"p8b_sound\" style=\"float:left;margin-left:10px\" onClick=\"p8_give_focus(); p8_create_audio_context(); Module.pico8ToggleSound();\"></div>\r\n\t\t<div class=\"p8_menu_button\" id=\"p8b_close\" style=\"float:right; margin-right:10px\" onClick=\"p8_close_cart();\"></div>\r\n\t</div>\r\n\r\n\t<div id=\"p8_container\"\r\n\t\tstyle=\"margin:auto; display:table;\"\r\n\t\tonclick=\"p8_create_audio_context(); p8_run_cart();\">\r\n\r\n\t\t<div id=\"p8_start_button\" class=\"p8_start_button\" style=\"width:100%; height:100%; display:flex;\">\r\n\t\t\t<img width=80 height=80 style=\"margin:auto;\"\r\n\t\tsrc=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAABQCAYAAACOEfKtAAABpklEQVR42u3au23DQBCEYUXOXIGKcujQXUgFuA0XIKgW90Q9oEAg+Ljd27vd2RsCf058gEDqhofPj+OB6SMCAQlIQAIyAhKQgARkBAQDnM6XSRsB7/2e/tSA0//12fCAKsQX3ntDA4oRFwBRIc0AixE38BAhTQGLEAsBUSDNAXcRhYDRIZsAPlp99VECRoXsDpgN0g0wC6Q7IDpkGEBUyG6A0+vKBtkdMBukG2AWSHdAdMgwgKiQ4QDRIMMCokCGB4wOCQPYFVKw2cABNocUjl6wgE0gFashPKAZpHJ2TQNYBVmxW6cDFENWDv9pAUshCVgJScBKSAISkD9hPkT4GkNAMdzepyj8Kye852EBLe51CZHHWQK4JcThD1SlcHPEYY/0a+A0n6SkGZV6w6WZNb3g4Id1b7hwgGhwYQBR4dwB0eHcALPAdQfMBhcOEA0uDCAqnDsgOpwbYBa4poA/31+rZYFrBriFpwGMCtcEcA9PAhgdzhywBK8EEQXOFFCCtwaIBmcGKMWbI6LCmQBq8R6hw5kAMgISkIAEJCAjIAEJSEBGQI9ukV7lRn9nD+gAAAAASUVORK5CYII=\"/>\r\n\t\t</div>\r\n\r\n\t\t<div id=\"p8_playarea\" style=\"display:none; margin:auto;\r\n\t\t\t\t-webkit-user-select:none; -moz-user-select: none; user-select: none; -webkit-touch-callout:none;\r\n\t\t\">\r\n\r\n\t\t\t<div  id=\"touch_controls_background\"\r\n\t\t\t\t  style=\" pointer-events:none; display:none; background-color:#000;\r\n\t\t\t\t\t\t position:fixed; top:0px; left:0px; border:0; width:100vw; height:100vh\">\r\n\t\t\t\t&nbsp\r\n\t\t\t</div>\r\n\r\n\t\t\t<div style=\"display:flex; position:relative\">\r\n\t\t\t\t<!-- pointer-events turned off for mobile in p8_update_layout because need for desktop mouse -->\r\n\t\t\t\t<canvas class=\"emscripten\" id=\"canvas\" oncontextmenu=\"event.preventDefault();\" >\r\n\t\t\t\t</canvas>\r\n\t\t\t\t<div class=p8_menu_buttons id=\"p8_menu_buttons\" style=\"margin-left:10px;\">\r\n\t\t\t\t\t<div class=\"p8_menu_button\" style=\"position:absolute; bottom:125px\" id=\"p8b_controls\" onClick=\"p8_give_focus(); Module.pico8ToggleControlMenu();\"></div>\t\t\t\t\t\r\n\t\t\t\t\t<div class=\"p8_menu_button\" style=\"position:absolute; bottom:90px\" id=\"p8b_pause\" onClick=\"p8_give_focus(); Module.pico8TogglePaused(); p8_update_layout_hash = -22;\"></div>\r\n\t\t\t\t\t<div class=\"p8_menu_button\" style=\"position:absolute; bottom:55px\" id=\"p8b_sound\" onClick=\"p8_give_focus(); p8_create_audio_context(); Module.pico8ToggleSound();\"></div>\r\n\t\t\t\t\t<div class=\"p8_menu_button\" style=\"position:absolute; bottom:20px\" id=\"p8b_full\" onClick=\"p8_give_focus(); p8_request_fullscreen();\"></div>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\r\n\r\n\t\t\t<!-- display after first layout update -->\r\n\t\t\t<div  id=\"touch_controls_gfx\"\r\n\t\t\t\t  style=\" pointer-events:none; display:table; \r\n\t\t\t\t\t\t position:fixed; top:0px; left:0px; border:0; width:100vw; height:100vh\">\r\n\r\n\t\t\t\t\t<img src=\"\" id=\"controls_right_panel\" style=\"position:absolute; opacity:0.5;\">\r\n\t\t\t\t\t<img src=\"\" id=\"controls_left_panel\" style=\"position:absolute;  opacity:0.5;\">\r\n\t\t\t\t\t\t\r\n\t\t\t\r\n\t\t\t</div> <!-- touch_controls_gfx -->\r\n\r\n\t\t\t<!-- used for clipboard access & keyboard input; displayed and used by PICO-8 only once needed. can be safely removed if clipboard / key presses not needed. -->\r\n\t\t\t<!-- (needs to be inside p8_playarea so that it still works under Chrome when fullscreened) -->\r\n\t\t\t<textarea id=\"codo_textarea\" class=\"emscripten\" style=\"display:none; position:absolute; left:-9999px; height:0px; overflow:hidden\"></textarea>\r\n\r\n\t\t</div> <!--p8_playarea -->\r\n\r\n\t</div> <!-- p8_container -->\r\n\r\n</div> <!-- p8_frame -->\r\n</div> <!-- p8_frame_0 size limit -->\r\n\r\n<script type=\"text/javascript\">\r\n\r\n\tp8_update_layout();\r\n\tp8_update_button_icons();\r\n\r\n\tvar canvas = document.getElementById(\"canvas\");\r\n\tModule = {};\r\n\tModule.canvas = canvas;\r\n\r\n\t// from @ultrabrite's shell: test if an AudioContext can be created outside of an event callback.\r\n\t// If it can't be created, then require pressing the start button to run the cartridge\r\n\r\n\tif (p8_autoplay)\r\n\t{\r\n\t\tvar temp_context = new AudioContext();\r\n\t\ttemp_context.onstatechange = function ()\r\n\t\t{\r\n\t\t\tif (temp_context.state=='running')\r\n\t\t\t{\r\n\t\t\t\tp8_run_cart();\r\n\t\t\t\ttemp_context.close();\r\n\t\t\t}\r\n\t\t};\r\n\t}\r\n\r\n\t// pointer lock request needs to be inside a canvas interaction event\r\n\t// pico8_state.request_pointer_lock is true when 0x5f2d bit 0 and bit 2 are set -- poke(0x5f2d,0x5) \r\n\t// note on mouse acceleration for future: // https://github.com/w3c/pointerlock/pull/49\r\n\tcanvas.addEventListener(\"click\", function()\r\n\t{\r\n\t\tif (!p8_touch_detected)\r\n\t\t\tif (pico8_state.request_pointer_lock)\r\n\t\t\t\tcanvas.requestPointerLock();\r\n\t});\r\n\t\r\n</script>\r\n\r\n\r\n<!-- Add content below the cart here -->\r\n\r\n\r\n</div> <!-- body_0 -->\r\n</body></html>\r\n\r\n<!-- 8< -- ## GL SHADER STUFF STARTS HERE ## -- -->\r\n\r\n<!-- Based on PICO-8 CRT framework by ultrabrite (twitter: @SpaceTrucker2k0) -->\r\n<!-- https://www.lexaloffle.com/bbs/?tid=33488 -->\r\n\r\n<!-- Updated with CRT shader by Mattias Gustavsson (twitter: @Mattias_G) -->\r\n<!-- https://github.com/mattiasgustavsson/crtview -->\r\n\r\n<!-- common vertex shader -->\r\n<script id=\"common-vertex-shader\" type=\"x-shader/x-vertex\">\r\n\tattribute vec4 pos;\r\n\tvarying vec2 uv;\r\n\tvoid main() {\r\n\t\tgl_Position = vec4(pos.xy, 0, 1);\r\n\t\tuv = pos.zw;\r\n\t}\r\n</script>\r\n\r\n<script id=\"crt-fragment-shader\" type=\"x-shader/x-fragment\">\r\n\tprecision mediump float;\r\n\tvarying vec2 uv;\r\n\tuniform vec2 resolution;\r\n\tuniform float time;\r\n\tuniform sampler2D backbuffer;\r\n\tuniform sampler2D blurbuffer;\r\n\tvec3 tsample(sampler2D samp, vec2 tc) {\r\n\t\tvec3 s=pow(abs(texture2D(samp,vec2(tc.x,1.0-tc.y)).rgb),vec3(2.2));\r\n\t\treturn s*vec3(1.25);\r\n\t}\r\n\tvec3 filmic(vec3 lcol) {\r\n\t\tvec3 x=max(vec3(0),lcol-vec3(0.004));\r\n\t\treturn (x*(6.2*x+0.5))/(x*(6.2*x+1.7)+0.06);\r\n\t}\r\n\tvec2 curve(vec2 uv) {\r\n\t\tuv=(uv-0.5)*2.0;\r\n\t\tuv*=vec2(1.049,1.042);\r\n\t\tuv-=vec2(-0.008,0.008);\r\n\t\tuv.x*=1.0+pow(abs(uv.y)/5.0,2.0);\r\n\t\tuv.y*=1.0+pow(abs(uv.x)/4.0,2.0);\r\n\t\tuv=uv*0.5+0.5;\r\n\t\treturn uv;\r\n\t}\r\n\thighp float rand(vec2 co) {\r\n\t\t/* iPad needs highp to avoid artifacts */\r\n\t\thighp float a = 12.9898;\r\n\t\thighp float b = 78.233;\r\n\t\thighp float c = 43758.5453;\r\n\t\thighp float dt = dot(co.xy,vec2(a,b));\r\n\t\thighp float sn = mod(dt,3.14);\r\n\t\treturn fract(sin(sn) * c);\r\n\t}\r\n\tvoid main() {\r\n\t\t/* curve */\r\n\t\tvec2 curved_uv=mix(curve(uv),uv,0.4);\r\n\t\t#if 0 /* dead code in original */\r\n\t\t\tfloat scale=0.04;\r\n\t\t\tvec2 scuv=curved_uv*(1.0-scale)+scale*0.5+vec2(0.003,-0.001);\r\n\t\t#else\r\n\t\t\tvec2 scuv=curved_uv;\r\n\t\t#endif\r\n\r\n\t\t/* main color, bleed */\r\n\t\tvec3 col;\r\n\t\tfloat x=sin(0.1*time+curved_uv.y*13.0)\r\n\t\t\t\t*sin(0.23*time+curved_uv.y*19.0)\r\n\t\t\t\t*sin(0.3+0.11*time+curved_uv.y*23.0)\r\n\t\t\t\t*0.0012;\r\n\t\tfloat o=sin(gl_FragCoord.y/1.5)/resolution.x;\r\n\t\tx+=o*0.25;\r\n\t\tx*=0.2;\r\n\t\tcol.r=tsample(backbuffer,vec2(x+scuv.x+0.0009,scuv.y+0.0009)).x+0.02;\r\n\t\tcol.g=tsample(backbuffer,vec2(x+scuv.x+0.0000,scuv.y-0.0011)).y+0.02;\r\n\t\tcol.b=tsample(backbuffer,vec2(x+scuv.x-0.0015,scuv.y+0.0000)).z+0.02;\r\n\r\n\t\tfloat i=clamp(col.r*0.299+col.g*0.587+col.b*0.114,0.0,1.0);\r\n\t\ti=pow(1.0-pow(i,2.0),1.0);\r\n\t\ti=(1.0-i)*0.85+0.15;\r\n\r\n\t\t/* ghosting */\r\n\t\tfloat ghs=0.15;\r\n\t\tvec3 r=tsample(blurbuffer, \r\n\t\t\tvec2(x-0.014*1.0, -0.027)*0.85\r\n\t\t\t\t+0.007*vec2(0.35*sin(1.0/7.0 + 15.0*curved_uv.y + 0.9*time), 0.35*sin(2.0/7.0 + 10.0*curved_uv.y + 1.37*time))\r\n\t\t\t\t+vec2(scuv.x+0.001,scuv.y+0.001)\r\n\t\t\t).xyz*vec3(0.5,0.25,0.25);\r\n\t\tvec3 g=tsample(blurbuffer, \r\n\t\t\tvec2(x-0.019*1.0, -0.020)*0.85\r\n\t\t\t\t+0.007*vec2(0.35*cos(1.0/9.0 + 15.0*curved_uv.y + 0.5*time), 0.35*sin(2.0/9.0 + 10.0*curved_uv.y + 1.50*time))\r\n\t\t\t\t+vec2(scuv.x+0.000,scuv.y-0.002)\r\n\t\t\t).xyz*vec3(0.25,0.5,0.25);\r\n\t\tvec3 b=tsample(blurbuffer, \r\n\t\t\tvec2(x-0.017*1.0, -0.003)*0.85\r\n\t\t\t\t+0.007*vec2(0.35*sin(2.0/3.0 + 15.0*curved_uv.y + 0.7*time), 0.35*cos(2.0/3.0 + 10.0*curved_uv.y + 1.63*time))\r\n\t\t\t\t+vec2(scuv.x-0.002,scuv.y+0.000)\r\n\t\t\t).xyz*vec3(0.25,0.25,0.5);\r\n\r\n\t\tvec3 ghost=vec3(0.0);\r\n\t\tghost+=vec3(ghs*(1.0-0.299))*pow(clamp(vec3(3.0)*r,vec3(0.0),vec3(1.0)),vec3(2.0))*vec3(i);\r\n\t\tghost+=vec3(ghs*(1.0-0.587))*pow(clamp(vec3(3.0)*g,vec3(0.0),vec3(1.0)),vec3(2.0))*vec3(i);\r\n\t\tghost+=vec3(ghs*(1.0-0.114))*pow(clamp(vec3(3.0)*b,vec3(0.0),vec3(1.0)),vec3(2.0))*vec3(i);\r\n\t\tcol+=ghost;\r\n\r\n\t\t/* level adjustment (curves) */\r\n\t\tcol*=vec3(0.95,1.05,0.95);\r\n\t\tcol=clamp(1.3*col+0.75*col*col+1.25*col*col*col*col*col,vec3(0.0),vec3(10.0));\r\n\r\n\t\t/* vignette */\r\n\t\tfloat vig=0.1+16.0*curved_uv.x*curved_uv.y*(1.0-curved_uv.x)*(1.0-curved_uv.y);\r\n\t\t#if 0 /* original */\r\n\t\t\tvig=1.3*pow(vig,0.5);\r\n\t\t#else /* less dark around edges; better for PICO-8 visibility */\r\n\t\t\tvig=1.5*pow(vig,0.25);\r\n\t\t\tvig=(vig>1.0) ? (1.0 + smoothstep(1.0,1.5,vig)*0.2) : vig;\r\n\t\t#endif\r\n\t\tcol*=vig;\r\n\r\n\t\t/* scanlines */\r\n\t\tfloat scans=clamp(0.35+0.18*sin(6.0*time+curved_uv.y*resolution.y*1.5),0.0,1.0);\r\n\t\tfloat s=pow(scans,0.9);\r\n\t\tcol*=s;\r\n\r\n\t\t/* vertical lines (shadow mask) */\r\n\t\tcol*=1.0-0.23*clamp((mod(gl_FragCoord.xy.x,3.0))*0.5,0.0,1.0);\r\n\t\t\r\n\t\t/* tone map */\r\n\t\tcol=filmic(col);\r\n\r\n\t\t/* noise */\r\n\t\tvec2 seed=curved_uv*resolution.xy;\r\n\t\tvec3 noise=pow(vec3(rand(seed+time),rand(seed+time*2.0),rand(seed+time*3.0)),vec3(1.5));\r\n\t\tcol-=0.015*noise;\r\n\r\n\t\t/* flicker */\r\n\t\tcol*=(1.0-0.004*(sin(50.0*time+curved_uv.y*2.0)*0.5+0.5));\r\n\r\n\t\t/* clamp */\r\n\t\tif (curved_uv.x < 0.0 || curved_uv.x > 1.0)\r\n\t\t\tcol*= 0.0;\r\n\t\tif (curved_uv.y < 0.0 || curved_uv.y > 1.0)\r\n\t\t\tcol*= 0.0;\r\n\r\n\t\tgl_FragColor = vec4(col, 1.0);\r\n\t}\r\n</script>\r\n\r\n<script id=\"blur-fragment-shader\" type=\"x-shader/x-fragment\">\r\n\tprecision mediump float;\r\n\tvarying vec2 uv;\r\n\tuniform vec2 blur;\r\n\tuniform sampler2D texture;\r\n\tvoid main() {\r\n\t\tvec4 sum=texture2D(texture,uv)*0.2270270270;\r\n\t\tsum+=texture2D(texture,vec2(uv.x-4.0*blur.x,uv.y-4.0*blur.y))*0.0162162162;\r\n\t\tsum+=texture2D(texture,vec2(uv.x-3.0*blur.x,uv.y-3.0*blur.y))*0.0540540541;\r\n\t\tsum+=texture2D(texture,vec2(uv.x-2.0*blur.x,uv.y-2.0*blur.y))*0.1216216216;\r\n\t\tsum+=texture2D(texture,vec2(uv.x-1.0*blur.x,uv.y-1.0*blur.y))*0.1945945946;\r\n\t\tsum+=texture2D(texture,vec2(uv.x+1.0*blur.x,uv.y+1.0*blur.y))*0.1945945946;\r\n\t\tsum+=texture2D(texture,vec2(uv.x+2.0*blur.x,uv.y+2.0*blur.y))*0.1216216216;\r\n\t\tsum+=texture2D(texture,vec2(uv.x+3.0*blur.x,uv.y+3.0*blur.y))*0.0540540541;\r\n\t\tsum+=texture2D(texture,vec2(uv.x+4.0*blur.x,uv.y+4.0*blur.y))*0.0162162162;\r\n\t\tgl_FragColor=sum;\r\n\t}\r\n</script>\r\n\r\n<script id=\"accumulate-fragment-shader\" type=\"x-shader/x-fragment\">\r\n\tprecision mediump float;\r\n\tvarying vec2 uv;\r\n\tuniform sampler2D tex0;\r\n\tuniform sampler2D tex1;\r\n\tuniform float modulate;\r\n\tvoid main() {\r\n\t\tvec4 a = texture2D(tex0, uv) * vec4(modulate);\r\n\t\tvec4 b = texture2D(tex1, uv);\r\n\t\tgl_FragColor = max(a, b * 0.96);\r\n\t}\r\n</script>\r\n\r\n<script id=\"blend-fragment-shader\" type=\"x-shader/x-fragment\">\r\n\tprecision mediump float;\r\n\tvarying vec2 uv;\r\n\tuniform sampler2D tex0;\r\n\tuniform sampler2D tex1;\r\n\tuniform float modulate;\r\n\tvoid main() {\r\n\t\tvec4 a = texture2D(tex0, uv) * vec4(modulate);\r\n\t\tvec4 b = texture2D(tex1, uv);\r\n\t\tgl_FragColor = max(a, b * 0.32);\r\n\t}\r\n</script>\r\n\r\n<script id=\"copy-fragment-shader\" type=\"x-shader/x-fragment\">\r\n\tprecision mediump float;\r\n\tvarying vec2 uv;\r\n\tuniform sampler2D tex0;\r\n\tvoid main() {\r\n\t\tgl_FragColor = texture2D(tex0, uv);\r\n\t}\r\n</script>\r\n\r\n<script type=\"text/javascript\">\r\n\tfunction p8_crt_effect_init(pico8_canvas) {\r\n\t\tvar canvas = document.createElement('canvas');\r\n\t\tcanvas.id = \"crtcanvas\";\r\n\t\tcanvas.className = \"canvas\";\r\n\t\tcanvas.style.position = \"absolute\";\r\n\t\tcanvas.style.top = 0;\r\n\t\tcanvas.style.left = 0;\r\n\t\tcanvas.width = pico8_canvas.clientWidth;\r\n\t\tcanvas.height = pico8_canvas.clientHeight;\r\n\t\tvar gl = canvas.getContext('webgl');\r\n\t\tif (!gl)\r\n\t\t\treturn;\r\n\r\n\t\tvar pico8_ctx = pico8_canvas.getContext('2d');\r\n\r\n\t\tpico8_canvas.parentNode.insertBefore(canvas, pico8_canvas);\r\n\t\t/* keep pico8_canvas in DOM for event handling, but hide it via opacity */\r\n\t\tpico8_canvas.style.opacity = 0;\r\n\r\n\t\tfunction unbind() {\r\n\t\t\tfor (var i = 0; i < arguments.length; ++i) {\r\n\t\t\t\tvar arg = arguments[i];\r\n\t\t\t\tswitch (arg) {\r\n\t\t\t\t\tcase gl.FRAMEBUFFER:\r\n\t\t\t\t\t\tgl.bindFramebuffer(arg, null);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase gl.TEXTURE_2D:\r\n\t\t\t\t\t\tgl.bindTexture(arg, null);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase gl.ARRAY_BUFFER:\r\n\t\t\t\t\t\tgl.bindBuffer(arg, null);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tdefault:\r\n\t\t\t\t\t\tgl.activeTexture(arg);\r\n\t\t\t\t\t\tgl.bindTexture(gl.TEXTURE_2D, null);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfunction compileShader(source, type) {\r\n\t\t\tvar shader = gl.createShader(type);\r\n\t\t\tgl.shaderSource(shader, source);\r\n\t\t\tgl.compileShader(shader);\r\n\t\t\tif (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {\r\n\t\t\t\tvar info = gl.getShaderInfoLog(shader);\r\n\t\t\t\tthrow (\"could not compile shader:\" + info);\r\n\t\t\t}\r\n\t\t\treturn shader;\r\n\t\t};\r\n\r\n\t\tvar vs = compileShader(document.getElementById(\"common-vertex-shader\").text, gl.VERTEX_SHADER);\r\n\t\tvar fs_crt = compileShader(document.getElementById(\"crt-fragment-shader\").text, gl.FRAGMENT_SHADER);\r\n\t\tvar fs_blur = compileShader(document.getElementById(\"blur-fragment-shader\").text, gl.FRAGMENT_SHADER);\r\n\t\tvar fs_accumulate = compileShader(document.getElementById(\"accumulate-fragment-shader\").text, gl.FRAGMENT_SHADER);\r\n\t\tvar fs_blend = compileShader(document.getElementById(\"blend-fragment-shader\").text, gl.FRAGMENT_SHADER);\r\n\t\tvar fs_copy = compileShader(document.getElementById(\"copy-fragment-shader\").text, gl.FRAGMENT_SHADER);\r\n\r\n\t\tfunction createProgram(vs, fs, name) {\r\n\t\t\tvar program = gl.createProgram();\r\n\t\t\tgl.attachShader(program, vs);\r\n\t\t\tgl.attachShader(program, fs);\r\n\t\t\tgl.linkProgram(program);\r\n\t\t\tif (!gl.getProgramParameter(program, gl.LINK_STATUS)) {\r\n\t\t\t\tvar info = gl.getProgramInfoLog(program);\r\n\t\t\t\tthrow (\"shader \" + name + \" failed to link:\" + info);\r\n\t\t\t}\r\n\t\t\treturn program;\r\n\t\t}\r\n\r\n\t\tvar crt_program = createProgram(vs, fs_crt, \"crt_program\");\r\n\t\tconst loc_crt_pos = gl.getAttribLocation(crt_program, \"pos\");\r\n\t\tconst loc_crt_time = gl.getUniformLocation(crt_program, \"time\");\r\n\t\tconst loc_crt_backbuffer = gl.getUniformLocation(crt_program, \"backbuffer\");\r\n\t\tconst loc_crt_blurbuffer = gl.getUniformLocation(crt_program, \"blurbuffer\");\r\n\t\tconst loc_crt_resolution = gl.getUniformLocation(crt_program, \"resolution\");\r\n\r\n\t\tvar blur_program = createProgram(vs, fs_blur, \"blur_program\");\r\n\t\tconst loc_blur_pos = gl.getAttribLocation(blur_program, \"pos\");\r\n\t\tconst loc_blur_blur = gl.getUniformLocation(blur_program, \"blur\");\r\n\t\tconst loc_blur_texture = gl.getUniformLocation(blur_program, \"texture\");\r\n\r\n\t\tvar accumulate_program = createProgram(vs, fs_accumulate, \"accumulate_program\");\r\n\t\tconst loc_accumulate_pos = gl.getAttribLocation(accumulate_program, \"pos\");\r\n\t\tconst loc_accumulate_tex0 = gl.getUniformLocation(accumulate_program, \"tex0\");\r\n\t\tconst loc_accumulate_tex1 = gl.getUniformLocation(accumulate_program, \"tex1\");\r\n\t\tconst loc_accumulate_modulate = gl.getUniformLocation(accumulate_program, \"modulate\");\r\n\r\n\t\tvar blend_program = createProgram(vs, fs_blend, \"blend_program\");\r\n\t\tconst loc_blend_pos = gl.getAttribLocation(blend_program, \"pos\");\r\n\t\tconst loc_blend_tex0 = gl.getUniformLocation(blend_program, \"tex0\");\r\n\t\tconst loc_blend_tex1 = gl.getUniformLocation(blend_program, \"tex1\");\r\n\t\tconst loc_blend_modulate = gl.getUniformLocation(blend_program, \"modulate\");\r\n\r\n\t\tvar copy_program = createProgram(vs, fs_copy, \"copy_program\");\r\n\t\tconst loc_copy_pos = gl.getAttribLocation(copy_program, \"pos\");\r\n\t\tconst loc_copy_tex0 = gl.getUniformLocation(copy_program, \"tex0\");\r\n\r\n\t\tvar posBuffer = gl.createBuffer();\r\n\t\tgl.bindBuffer(gl.ARRAY_BUFFER, posBuffer);\r\n\t\tgl.bufferData(gl.ARRAY_BUFFER, new Float32Array(\r\n\t\t\t[-1, -1, 0, 0,\r\n\t\t\t\t1, -1, 1, 0,\r\n\t\t\t\t1,  1, 1, 1,\r\n\t\t\t\t-1,  1, 0, 1]), gl.STATIC_DRAW);\r\n\t\tunbind(gl.ARRAY_BUFFER);\r\n\r\n\t\tfunction bindVertexBuffer(loc_pos) {\r\n\t\t\tgl.bindBuffer(gl.ARRAY_BUFFER, posBuffer);\r\n\t\t\tgl.vertexAttribPointer(loc_pos, 4, gl.FLOAT, false, 0, 0);\r\n\t\t\tgl.enableVertexAttribArray(loc_pos);\r\n\t\t}\r\n\r\n\t\tvar tex_backbuffer = gl.createTexture();\r\n\t\tgl.activeTexture(gl.TEXTURE0);\r\n\t\tgl.bindTexture(gl.TEXTURE_2D, tex_backbuffer);\r\n\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\r\n\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\r\n\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);\r\n\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);\r\n\t\tunbind(gl.TEXTURE_2D)\r\n\r\n\t\tvar texfbos = [];\r\n\t\tfor (var i = 0; i < 4; ++i) {\r\n\t\t\tvar tex = gl.createTexture();\r\n\t\t\tgl.activeTexture(gl.TEXTURE0);\r\n\t\t\tgl.bindTexture(gl.TEXTURE_2D,  tex);\r\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\r\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\r\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);\r\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);\r\n\t\t\tunbind(gl.TEXTURE_2D)\r\n\t\t\tvar fbo = gl.createFramebuffer();\r\n\t\t\ttexfbos.push({tex: tex, fbo: fbo});\r\n\t\t}\r\n\t\tconst blur_buf = texfbos[0];\r\n\t\tconst blur_tmp = texfbos[1];\r\n\t\tconst accum_buf = texfbos[2];\r\n\t\tconst accum_cpy = texfbos[3];\r\n\r\n\t\tfunction drawBlurAxis(srctex, dstbuf, blurx, blury) {\r\n\t\t\tgl.bindFramebuffer(gl.FRAMEBUFFER, dstbuf);\r\n\t\t\tgl.useProgram(blur_program);\r\n\t\t\tbindVertexBuffer(loc_blur_pos);\r\n\t\t\tgl.uniform2f(loc_blur_blur, blurx, blury);\r\n\t\t\tgl.uniform1i(loc_blur_texture, 0);\r\n\t\t\tgl.activeTexture(gl.TEXTURE0);\r\n\t\t\tgl.bindTexture(gl.TEXTURE_2D, srctex);\r\n\t\t\tgl.drawArrays(gl.TRIANGLE_FAN, 0, 4);\r\n\t\t\tunbind(gl.TEXTURE_2D, gl.ARRAY_BUFFER, gl.FRAMEBUFFER);\r\n\t\t}\r\n\r\n\t\tfunction drawBlur(srctex, dstbuf, tmp, r, w, h) {\r\n\t\t\tdrawBlurAxis(srctex, tmp.fbo, r/w, 0);\r\n\t\t\tdrawBlurAxis(tmp.tex, dstbuf, 0, r/h);\r\n\t\t}\r\n\r\n\t\tfunction drawCopy(srctex, dstbuf) {\r\n\t\t\tgl.bindFramebuffer(gl.FRAMEBUFFER, dstbuf);\r\n\t\t\tgl.useProgram(copy_program);\r\n\t\t\tbindVertexBuffer(loc_copy_pos);\r\n\t\t\tgl.uniform1i(loc_copy_tex0, 0);\r\n\t\t\tgl.activeTexture(gl.TEXTURE0);\r\n\t\t\tgl.bindTexture(gl.TEXTURE_2D, srctex);\r\n\t\t\tgl.drawArrays(gl.TRIANGLE_FAN, 0, 4);\r\n\t\t\tunbind(gl.TEXTURE_2D, gl.ARRAY_BUFFER, gl.FRAMEBUFFER);\r\n\t\t}\r\n\r\n\t\tvar lastdw = -1;\r\n\t\tvar lastdh = -1;\r\n\r\n\t\tfunction draw(now) {\r\n\t\t\tvar time = now * 0.001;\r\n\r\n\t\t\t/* hack fix for Safari: texImage2D fails to copy pico8_canvas to tex_backbuffer */\r\n\t\t\tpico8_ctx.resetTransform();\r\n\t\t\tpico8_ctx.clearRect(-1, -1, 1, 1);\r\n\r\n\t\t\tvar p8scale = Math.ceil(Math.max(\r\n\t\t\t\tpico8_canvas.clientWidth / pico8_canvas.width,\r\n\t\t\t\tpico8_canvas.clientHeight / pico8_canvas.height));\r\n\t\t\tp8scale = Math.max(1, Math.min(4, p8scale));\r\n\r\n\t\t\tvar dw = pico8_canvas.width * p8scale;\r\n\t\t\tvar dh = pico8_canvas.height * p8scale;\r\n\r\n\t\t\tif (lastdw != dw || lastdh != dh) {\r\n\t\t\t\tfor (var i = 0; i < texfbos.length; ++i) {\r\n\t\t\t\t\tvar texture = texfbos[i].tex;\r\n\t\t\t\t\tvar framebuffer = texfbos[i].fbo;\r\n\t\t\t\t\tgl.activeTexture(gl.TEXTURE0);\r\n\t\t\t\t\tgl.bindTexture(gl.TEXTURE_2D, texture);\r\n\t\t\t\t\tgl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, dw, dh, 0, gl.RGBA, gl.UNSIGNED_BYTE, null);\r\n\t\t\t\t\tgl.bindFramebuffer(gl.FRAMEBUFFER, framebuffer);\r\n\t\t\t\t\tgl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, texture, 0);\r\n\t\t\t\t\tunbind(gl.TEXTURE_2D, gl.FRAMEBUFFER);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t/* blit pico8 screen to backbuffer; backbuffer = texImage2D(pico8_canvas) */\r\n\t\t\tgl.activeTexture(gl.TEXTURE0);\r\n\t\t\tgl.bindTexture(gl.TEXTURE_2D, tex_backbuffer);\r\n\t\t\tgl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, pico8_canvas);\r\n\t\t\tunbind(gl.TEXTURE_2D);\r\n\r\n\t\t\tgl.viewport(0, 0, dw, dh);\r\n\r\n\t\t\t/* blur previous accumulation buffer; blur_buf = blur(accum_cpy) */\r\n\t\t\tdrawBlur(accum_cpy.tex, blur_buf.fbo, blur_tmp, 1.0, dw, dh);\r\n\r\n\t\t\t/* update accumulation buffer; accum_buf = accumulate(backbuffer, blur_buf) */\r\n\t\t\tgl.bindFramebuffer(gl.FRAMEBUFFER, accum_buf.fbo);\r\n\t\t\tgl.useProgram(accumulate_program);\r\n\t\t\tbindVertexBuffer(loc_accumulate_pos);\r\n\t\t\tgl.uniform1i(loc_accumulate_tex0, 0);\r\n\t\t\tgl.uniform1i(loc_accumulate_tex1, 1);\r\n\t\t\tgl.uniform1f(loc_accumulate_modulate, 1.0);\r\n\t\t\tgl.activeTexture(gl.TEXTURE0);\r\n\t\t\tgl.bindTexture(gl.TEXTURE_2D, tex_backbuffer);\r\n\t\t\tgl.activeTexture(gl.TEXTURE1);\r\n\t\t\tgl.bindTexture(gl.TEXTURE_2D, blur_buf.tex);\r\n\t\t\tgl.drawArrays(gl.TRIANGLE_FAN, 0, 4);\r\n\t\t\tunbind(gl.TEXTURE0, gl.TEXTURE1, gl.ARRAY_BUFFER, gl.FRAMEBUFFER);\r\n\r\n\t\t\t/* store copy of accumulation buffer; accum_cpy = copy(accum_buf) */\r\n\t\t\tdrawCopy(accum_buf.tex, accum_cpy.fbo);\r\n\r\n\t\t\t/* blend accumulation and backbuffer; accum_buf = blend(backbuffer, accum_cpy) */\r\n\t\t\tgl.bindFramebuffer(gl.FRAMEBUFFER, accum_buf.fbo);\r\n\t\t\tgl.useProgram(blend_program);\r\n\t\t\tbindVertexBuffer(loc_blend_pos);\r\n\t\t\tgl.uniform1i(loc_blend_tex0, 0);\r\n\t\t\tgl.uniform1i(loc_blend_tex1, 1);\r\n\t\t\tgl.uniform1f(loc_blend_modulate, 1.0);\r\n\t\t\tgl.activeTexture(gl.TEXTURE0);\r\n\t\t\tgl.bindTexture(gl.TEXTURE_2D, tex_backbuffer);\r\n\t\t\tgl.activeTexture(gl.TEXTURE1);\r\n\t\t\tgl.bindTexture(gl.TEXTURE_2D, accum_cpy.tex);\r\n\t\t\tgl.drawArrays(gl.TRIANGLE_FAN, 0, 4);\r\n\t\t\tunbind(gl.TEXTURE0, gl.TEXTURE1, gl.ARRAY_BUFFER, gl.FRAMEBUFFER);\r\n\r\n\t\t\t/* add slight blur to backbuffer; accum_buf = blur(accum_buf) */\r\n\t\t\tdrawBlur(accum_buf.tex, accum_buf.fbo, blur_tmp, 0.17, dw, dh);\r\n\r\n\t\t\t/* create fully blurred version of backbuffer; blur_buf = blur(accum_buf) */\r\n\t\t\tdrawBlur(accum_buf.tex, blur_buf.fbo, blur_tmp, 1.0, dw, dh);\r\n\r\n\t\t\t/* ensure crt canvas overlays pico8_canvas */\r\n\t\t\tcanvas.style.top = pico8_canvas.offsetTop;\r\n\t\t\tcanvas.style.left = pico8_canvas.offsetLeft;\r\n\t\t\tvar cw = canvas.width = pico8_canvas.clientWidth;\r\n\t\t\tvar ch = canvas.height = pico8_canvas.clientHeight;\r\n\t\t\tgl.viewport(0, 0, cw, ch);\r\n\r\n\t\t\t/* apply crt shader; canvas = crt(accum_buf, blur_buf) */\r\n\t\t\tgl.bindFramebuffer(gl.FRAMEBUFFER, null);\r\n\t\t\tgl.useProgram(crt_program);\r\n\t\t\tbindVertexBuffer(loc_crt_pos);\r\n\t\t\tgl.activeTexture(gl.TEXTURE0);\r\n\t\t\tgl.bindTexture(gl.TEXTURE_2D, accum_buf.tex);\r\n\t\t\tgl.activeTexture(gl.TEXTURE1);\r\n\t\t\tgl.bindTexture(gl.TEXTURE_2D, blur_buf.tex);\r\n\t\t\tgl.uniform2f(loc_crt_resolution, cw, ch);\r\n\t\t\tgl.uniform1f(loc_crt_time, 1.5 * time);\r\n\t\t\tgl.uniform1i(loc_crt_backbuffer, 0);\r\n\t\t\tgl.uniform1i(loc_crt_blurbuffer, 1);\r\n\t\t\tgl.drawArrays(gl.TRIANGLE_FAN, 0, 4);\r\n\t\t\tunbind(gl.TEXTURE0, gl.TEXTURE1, gl.ARRAY_BUFFER, gl.FRAMEBUFFER);\r\n\r\n\t\t\tlastdw = dw;\r\n\t\t\tlastdh = dh;\r\n\r\n\t\t\trequestAnimationFrame(draw);\r\n\t\t}\r\n\r\n\t\trequestAnimationFrame(draw);\r\n\t}\r\n</script>\r\n<!-- 8< -- ## GL SHADER STUFF ENDS HERE ## -- -->"
        }
    ]
}