<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LEMEGETON: Path of the Zenith</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --ff-blue-top: #000066;
            --ff-blue-bottom: #000033;
            --ff-border: #ffffff;
            --term-green: #00ff41;
            --term-magenta: #ff00ff;
            --term-cyan: #00ffff;
            --term-yellow: #ffff00;
            --term-white: #ffffff;
            --glow: 0 0 10px rgba(0, 255, 255, 0.5);
            --pixel-font: 'Press Start 2P', cursive;
        }

        body, html {
            margin: 0; padding: 0;
            background-color: #000;
            color: var(--term-white);
            font-family: var(--pixel-font);
            font-size: 11px;
            height: 100%;
            overflow: hidden;
        }

        #main-layout {
            display: flex;
            height: 100vh;
            width: 100vw;
            box-sizing: border-box;
            background: linear-gradient(to bottom, var(--ff-blue-top), var(--ff-blue-bottom));
            padding: 10px;
            gap: 10px;
        }

        .crt-overlay {
            position: fixed;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.02), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.02));
            z-index: 100;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }

        .ff-window {
            background: linear-gradient(135deg, rgba(0,0,102,0.85), rgba(0,0,51,0.95));
            border: 2px solid var(--ff-border);
            box-shadow: inset 0 0 0 2px #000, 0 0 15px rgba(0,0,0,0.5);
            position: relative;
            display: flex;
            flex-direction: column;
        }

        #sidebar { width: 260px; padding: 15px; gap: 15px; flex-shrink: 0; }

        .gui-panel {
            border: 1px solid rgba(255,255,255,0.2);
            padding: 10px;
            background: rgba(255,255,255,0.05);
            margin-bottom: 10px;
        }

        .gui-header {
            font-weight: bold;
            color: var(--term-cyan);
            border-bottom: 1px solid rgba(255,255,255,0.2);
            margin-bottom: 10px;
            padding-bottom: 5px;
            text-transform: uppercase;
            font-size: 0.8em;
        }

        .stat-row { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 0.75em; }
        .stat-value { color: var(--term-white); }

        /* Clock Visual */
        #heptagram-container {
            position: relative;
            width: 180px;
            height: 180px;
            margin: 10px auto;
        }

        .planet-node {
            position: absolute;
            width: 34px;
            height: 34px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            background: rgba(0,0,0,0.5);
            transition: all 0.3s;
        }

        .planet-node.active-day {
            border: 2px solid var(--term-yellow);
            box-shadow: 0 0 15px var(--term-yellow);
            background: rgba(255, 255, 0, 0.2);
        }

        .planet-node.active-hour {
            color: var(--term-magenta);
            text-shadow: 0 0 8px var(--term-magenta);
        }

        /* Terminal */
        #terminal-wrapper { flex: 1; overflow: hidden; }

        .lore-terminal {
            height: 100% !important;
            width: 100% !important;
            background-color: transparent !important;
            color: var(--term-white) !important;
            font-family: var(--pixel-font) !important;
            padding: 15px !important;
            box-sizing: border-box !important;
            display: flex !important;
            flex-direction: column !important;
        }

        .lore-output {
            flex: 1 !important;
            overflow-y: auto !important;
            margin-bottom: 15px !important;
            font-size: 10px;
            line-height: 1.6 !important;
        }

        .lore-input-container {
            background: rgba(0, 0, 0, 0.5) !important;
            padding: 10px !important;
            border: 1px solid rgba(255, 255, 255, 0.3);
            display: flex !important;
        }

        .lore-input {
            color: var(--term-cyan) !important;
            font-family: var(--pixel-font) !important;
            font-size: 11px !important;
            background: transparent !important;
            border: none !important;
            outline: none !important;
            flex: 1;
            margin-left: 10px !important;
        }

        .lore-output::-webkit-scrollbar { width: 6px; }
        .lore-output::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }

        /* Menu Overlay */
        #menu-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
        }

        #menu-window {
            width: 500px;
            height: 400px;
            display: flex;
            flex-direction: column;
        }

        .menu-tabs {
            display: flex;
            background: rgba(255,255,255,0.1);
            border-bottom: 2px solid var(--ff-border);
        }

        .menu-tab {
            padding: 10px 15px;
            cursor: pointer;
            text-transform: uppercase;
            font-size: 0.8em;
            border-right: 1px solid rgba(255,255,255,0.2);
        }

        .menu-tab.active {
            background: var(--ff-blue-top);
            color: var(--term-cyan);
            border-bottom: 2px solid var(--term-cyan);
            margin-bottom: -2px;
        }

        .menu-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .menu-section { display: none; }
        .menu-section.active { display: block; }

        .menu-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid var(--ff-border);
            color: white;
            padding: 10px;
            font-family: var(--pixel-font);
            font-size: 0.7em;
            cursor: pointer;
            margin-bottom: 10px;
            width: 100%;
            text-align: left;
        }

        .menu-btn:hover {
            background: rgba(255,255,255,0.2);
            color: var(--term-yellow);
        }

        .menu-label {
            font-size: 0.7em;
            margin-bottom: 5px;
            color: var(--term-cyan);
            text-transform: uppercase;
        }

        input[type="range"] {
            width: 100%;
            margin-bottom: 15px;
        }

        .server-code-display {
            background: rgba(0,0,0,0.5);
            border: 1px dashed var(--term-magenta);
            padding: 15px;
            text-align: center;
            font-size: 1.2em;
            color: var(--term-magenta);
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="crt-overlay"></div>
    <div id="main-layout">
        <aside id="sidebar" class="ff-window">
            <div class="gui-panel">
                <div class="gui-header">Planetary Clock</div>
                <div id="stat-day-num" class="stat-row"><span>Day</span> <span class="stat-value">1</span></div>
                <div class="stat-row"><span>Current Day</span> <span id="stat-day-sym" class="stat-value">♄</span></div>
                <div class="stat-row"><span>Current Hour</span> <span id="stat-hour-sym" class="stat-value">♄</span></div>
                
                <div id="heptagram-container">
                    <!-- Nodes will be positioned by JS -->
                </div>
            </div>

            <div class="gui-panel">
                <div class="gui-header">Vitals</div>
                <div class="stat-row"><span>SANITY</span> <span id="stat-sanity" class="stat-value">100</span></div>
                <div class="stat-row"><span>WRATH</span> <span id="stat-wrath" class="stat-value">0</span></div>
                <div class="stat-row"><span>LOYALTY</span> <span id="stat-loyalty" class="stat-value">0</span></div>
            </div>

            <div class="gui-panel">
                <div class="gui-header">Status</div>
                <div class="stat-row"><span>PLAYER</span> <span id="stat-player" class="stat-value">Desdemona</span></div>
                <div class="stat-row"><span>RANK</span> <span id="stat-rank" class="stat-value">Novice</span></div>
                <div class="stat-row"><span>TURNS</span> <span id="stat-turns" class="stat-value">0</span></div>
            </div>

            <div class="gui-panel" style="flex:1; overflow-y:auto;">
                <div class="gui-header">Inventory</div>
                <ul id="inventory-list" style="list-style:none; padding:0; font-size:0.7em; color:var(--term-yellow);"></ul>
            </div>

            <button id="btn-open-menu" class="menu-btn" style="margin-top:auto; text-align:center; border-width:2px;">SYSTEM MENU</button>
        </aside>

        <main id="terminal-wrapper" class="ff-window">
            <div id="game-container" class="lore-terminal"></div>
        </main>
    </div>

    <div id="menu-overlay">
        <div id="menu-window" class="ff-window">
            <div class="menu-tabs">
                <div class="menu-tab active" data-tab="audio">Audio</div>
                <div class="menu-tab" data-tab="save">Save/Load</div>
                <div class="menu-tab" data-tab="settings">Settings</div>
                <div class="menu-tab" data-tab="multi">Multiplayer</div>
                <div class="menu-tab" id="btn-close-menu" style="margin-left:auto; border-right:none; border-left:1px solid rgba(255,255,255,0.2);">X</div>
            </div>
            <div class="menu-content">
                <!-- Audio Section -->
                <div id="tab-audio" class="menu-section active">
                    <div class="menu-label">Master Volume</div>
                    <input type="range" id="volume-master" min="0" max="100" value="80">
                    <div class="menu-label">Music Volume</div>
                    <input type="range" id="volume-music" min="0" max="100" value="60">
                    <button class="menu-btn" id="btn-mute">Mute All Audio</button>
                </div>

                <!-- Save/Load Section -->
                <div id="tab-save" class="menu-section">
                    <button class="menu-btn" id="btn-save-game">Save Game (Slot 1)</button>
                    <button class="menu-btn" id="btn-load-game">Load Game (Slot 1)</button>
                    <hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); margin:15px 0;">
                    <button class="menu-btn" id="btn-download-logs" style="border-color:var(--term-green); color:var(--term-green);">DOWNLOAD SESSION LOGS (.TXT)</button>
                </div>

                <!-- Settings Section -->
                <div id="tab-settings" class="menu-section">
                    <div class="menu-label">Character Name</div>
                    <div style="display:flex; gap:10px; margin-bottom:15px;">
                        <input type="text" id="input-player-name" style="flex:1; background:rgba(0,0,0,0.5); border:1px solid var(--ff-border); color:white; padding:5px; font-family:var(--pixel-font); font-size:0.7em;" placeholder="Enter name...">
                        <button class="menu-btn" id="btn-change-name" style="width:auto; margin-bottom:0;">SET</button>
                    </div>
                    <div class="menu-label">Text Speed</div>
                    <input type="range" id="setting-text-speed" min="1" max="100" value="20">
                    <button class="menu-btn" id="btn-clear-history">Clear Command History</button>
                    <button class="menu-btn" id="btn-reset-game" style="border-color:var(--term-red); color:var(--term-red);">Hard Reset Game</button>
                </div>

                <!-- Multiplayer Section -->
                <div id="tab-multi" class="menu-section">
                    <div id="multi-init">
                        <button class="menu-btn" id="btn-multi-host">Host New Session</button>
                        <button class="menu-btn" id="btn-multi-join">Join Session with Code</button>
                    </div>
                    <div id="multi-hosting" style="display:none;">
                        <div class="menu-label">Server Code</div>
                        <div class="server-code-display" id="display-server-code">----</div>
                        <button class="menu-btn" id="btn-copy-invite" style="margin-bottom: 15px; border-color: var(--term-cyan); color: var(--term-cyan);">Copy Invite Link</button>
                        <div class="menu-label">Players (1/4)</div>
                        <ul id="multi-player-list" style="font-size:0.7em; margin-bottom:15px;">
                            <li>Desdemona (NPC)</li>
                            <li id="li-me-player" style="color:var(--term-green);">You (Cultist 1)</li>
                        </ul>
                        <button class="menu-btn" id="btn-stop-multi">Stop Hosting</button>
                        <button class="menu-btn" id="btn-leave-multi" style="display:none;">Leave Session</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="lore.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <script>
        const PLANETS = [
            { name: "Saturn", symbol: "♄", color: "#aaa" },
            { name: "Jupiter", symbol: "♃", color: "#f90" },
            { name: "Mars", symbol: "♂", color: "#f33" },
            { name: "Sun", symbol: "☉", color: "#ff0" },
            { name: "Venus", symbol: "♀", color: "#f9f" },
            { name: "Mercury", symbol: "☿", color: "#3ff" },
            { name: "Moon", symbol: "☽", color: "#fff" }
        ];

        // Chaldean Order for hours (Saturday starts with Saturn)
        const CHALDEAN_ORDER = [0, 1, 2, 3, 4, 5, 6]; // Indices into PLANETS

        // Day Order (Saturday, Sunday, Monday, Tuesday, Wednesday, Thursday, Friday)
        // Saturday=Saturn, Sunday=Sun, Monday=Moon, Tuesday=Mars, Wednesday=Mercury, Thursday=Jupiter, Friday=Venus
        const DAY_ORDER = [0, 3, 6, 2, 5, 1, 4];

        document.addEventListener('DOMContentLoaded', async () => {
            const container = document.getElementById('heptagram-container');
            const nodes = [];

            // Position planets in heptagram
            PLANETS.forEach((p, i) => {
                const node = document.createElement('div');
                node.className = 'planet-node';
                node.innerHTML = p.symbol;
                node.title = p.name;
                const angle = (i * (360 / 7) - 90) * (Math.PI / 180);
                const r = 70;
                node.style.left = (90 + r * Math.cos(angle) - 17) + 'px';
                node.style.top = (90 + r * Math.sin(angle) - 17) + 'px';
                container.appendChild(node);
                nodes.push(node);
            });

            const game = new LORE.Game({
                container: '#game-container',
                prompt: "{{magenta}}❯{{color_reset}} ",
                typingSpeed: 20,
                clearScreenOnNovelLoad: false
            });

            // Make game globally accessible for debugging if needed
            window.game = game;

            const updateGUI = () => {
                const s = game.state;
                const f = s.flags || {};
                const turns = f.gameTime || 0;
                
                // 1 turn = 15 mins. 4 turns = 1 hour. 96 turns = 1 day.
                const totalHours = Math.floor(turns / 4);
                const dayNum = Math.floor(totalHours / 24) + 1;
                
                // Day of week (0=Sat, 1=Sun...)
                const dayIdx = (dayNum - 1) % 7;
                const dayPlanetIdx = DAY_ORDER[dayIdx];
                
                // Hour Planet (Chaldean sequence continues forever)
                const hourPlanetIdx = totalHours % 7;

                document.getElementById('stat-day-num').querySelector('.stat-value').textContent = dayNum;
                document.getElementById('stat-day-sym').textContent = PLANETS[dayPlanetIdx].symbol;
                document.getElementById('stat-day-sym').style.color = PLANETS[dayPlanetIdx].color;
                document.getElementById('stat-hour-sym').textContent = PLANETS[hourPlanetIdx].symbol;
                document.getElementById('stat-hour-sym').style.color = PLANETS[hourPlanetIdx].color;

                nodes.forEach((node, i) => {
                    node.classList.remove('active-day', 'active-hour');
                    node.style.color = PLANETS[i].color;
                    node.style.borderColor = 'rgba(255,255,255,0.1)';
                    node.style.boxShadow = 'none';

                    if (i === dayPlanetIdx) {
                        node.classList.add('active-day');
                        node.style.borderColor = PLANETS[i].color;
                        node.style.boxShadow = `0 0 15px ${PLANETS[i].color}`;
                    }
                    if (i === hourPlanetIdx) {
                        node.classList.add('active-hour');
                        node.style.textShadow = `0 0 10px ${PLANETS[i].color}`;
                    }
                });

                document.getElementById('stat-sanity').textContent = f.sanity ?? 100;
                document.getElementById('stat-wrath').textContent = f.wrath ?? 0;
                document.getElementById('stat-loyalty').textContent = f.loyalty ?? 0;
                
                document.getElementById('stat-player').textContent = f.playerName ?? "Desdemona";
                document.getElementById('stat-rank').textContent = f.cultRank ?? "Novice";
                document.getElementById('stat-turns').textContent = turns;

                const invList = document.getElementById('inventory-list');
                invList.innerHTML = s.inventory.length ? s.inventory.map(i => `<li>> ${i.replace(/_/g, ' ').toUpperCase()}</li>`).join('') : '<li>(EMPTY)</li>';
            };

            const parseSayMessage = (rawInput) => {
                if (!rawInput || !rawInput.includes('"')) return null;

                const firstQuote = rawInput.indexOf('"');
                const lastQuote = rawInput.lastIndexOf('"');
                if (firstQuote === lastQuote) return null;

                let prefixText = rawInput.slice(0, firstQuote).trim();
                if (prefixText.toLowerCase().startsWith('say ')) {
                    prefixText = prefixText.slice(4).trim();
                } else if (prefixText.toLowerCase() === 'say') {
                    prefixText = '';
                }

                const spokenText = rawInput.slice(firstQuote + 1, lastQuote).trim();
                if (!spokenText) return null;

                return {
                    prefix: prefixText ? `(${prefixText})` : '',
                    text: spokenText
                };
            };

            const handleSayInput = (rawInput) => {
                const sayPayload = parseSayMessage(rawInput);
                if (!sayPayload) return false;

                game.printLine(`{{green}}${game.state.flags.playerName}${sayPayload.prefix}: "${sayPayload.text}"{{color_reset}}`);
                if (game.state.flags.isMultiplayer) {
                    window.broadcastMsg('say', sayPayload);
                }
                return true;
            };

            // Override processInput to support quote-say syntax and update GUI.
            const originalProcessInput = game.processInput;
            game.processInput = function(input) {
                const handledSay = handleSayInput(input);
                const result = handledSay ? true : originalProcessInput.call(this, input);
                updateGUI();
                return result;
            };

            // --- Menu Logic ---
            const menuOverlay = document.getElementById('menu-overlay');
            const btnOpenMenu = document.getElementById('btn-open-menu');
            const btnCloseMenu = document.getElementById('btn-close-menu');
            const tabs = document.querySelectorAll('.menu-tab[data-tab]');
            const sections = document.querySelectorAll('.menu-section');

            btnOpenMenu.onclick = () => menuOverlay.style.display = 'flex';
            btnCloseMenu.onclick = () => menuOverlay.style.display = 'none';

            tabs.forEach(tab => {
                tab.onclick = () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    sections.forEach(s => s.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
                };
            });

            // --- Audio Logic ---
            let isMuted = false;
            const btnMute = document.getElementById('btn-mute');
            btnMute.onclick = () => {
                isMuted = !isMuted;
                btnMute.textContent = isMuted ? 'Unmute All Audio' : 'Mute All Audio';
                // Logic to actually mute audio would go here
                game.printLine(isMuted ? '{{gray}}[Audio Muted]{{color_reset}}' : '{{gray}}[Audio Unmuted]{{color_reset}}');
            };

            // --- Save/Load & Logs ---
            document.getElementById('btn-save-game').onclick = () => {
                game.saveGame();
                game.printLine('{{green}}Game state captured in Slot 1.{{color_reset}}');
            };
            document.getElementById('btn-load-game').onclick = () => {
                game.loadGame();
                updateGUI();
            };

            document.getElementById('btn-download-logs').onclick = () => {
                const output = document.getElementById('game-container').querySelector('.lore-output');
                const logText = output.innerText || output.textContent;
                const blob = new Blob([logText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `lemegeton_session_${new Date().toISOString().slice(0,10)}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                game.printLine('{{green}}Session logs downloaded successfully.{{color_reset}}');
            };

            // --- Settings ---
            const speedSlider = document.getElementById('setting-text-speed');
            speedSlider.oninput = () => {
                game.config.typingSpeed = parseInt(speedSlider.value);
            };

            const inputPlayerName = document.getElementById('input-player-name');
            document.getElementById('btn-change-name').onclick = () => {
                const newName = inputPlayerName.value.trim();
                if (newName) {
                    game.state.flags.playerName = newName;
                    game.printLine(`{{green}}Identity updated: You are now known as ${newName}.{{color_reset}}`);
                    updateGUI();
                    inputPlayerName.value = '';
                }
            };

            document.getElementById('btn-clear-history').onclick = () => {
                game.state.history = [];
                game.printLine('{{gray}}Command history cleared.{{color_reset}}');
            };

            document.getElementById('btn-reset-game').onclick = () => {
                if (confirm('Are you sure you want to completely reset? All progress will be lost.')) {
                    localStorage.removeItem('lore_save_data');
                    location.reload();
                }
            };

            // --- Multiplayer Logic (PeerJS Real-time MUD) ---
            const multiInit = document.getElementById('multi-init');
            const multiHosting = document.getElementById('multi-hosting');
            const serverCodeDisplay = document.getElementById('display-server-code');
            const btnStopMulti = document.getElementById('btn-stop-multi');
            const btnLeaveMulti = document.getElementById('btn-leave-multi');

            let peer = null;
            let connections = []; // For Host: list of all connected clients

            const PEER_CONFIG = {
                debug: 3, // Full verbosity for debugging
                config: {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun2.l.google.com:19302' }
                    ]
                }
            };

            window.broadcastMsg = (type, data) => {
                const msg = {
                    from: game.state.flags.playerName,
                    type,
                    data,
                    ts: Date.now()
                };
                
                if (game.state.flags.isHost) {
                    connections.forEach(conn => { if (conn.open) conn.send(msg); });
                } else if (peer && connections[0] && connections[0].open) {
                    connections[0].send(msg);
                }
            };

            window.handleIncomingMsg = (msg) => {
                if (msg.from === game.state.flags.playerName) return;

                switch(msg.type) {
                    case 'say':
                        game.printLine(`{{green}}${msg.from}${msg.data.prefix}: "${msg.data.text}"{{color_reset}}`);
                        break;
                    case 'emote':
                        game.printLine(`{{magenta}}* ${msg.from} ${msg.data.action}{{color_reset}}`);
                        break;
                    case 'move':
                        game.printLine(`{{gray}}[MUD] ${msg.from} moves ${msg.data.dir} to ${msg.data.roomName}{{color_reset}}`);
                        break;
                    case 'join':
                        game.printLine(`{{cyan}}[MUD] ${msg.data.name} has entered the realm.{{color_reset}}`);
                        break;
                    case 'leave':
                        game.printLine(`{{red}}[MUD] ${msg.data.name} has left the realm.{{color_reset}}`);
                        break;
                }

                if (game.state.flags.isHost) {
                    connections.forEach(conn => {
                        if (conn.peer !== msg.peerId && conn.open) conn.send(msg);
                    });
                }
            };

            window.setupMultiplayer = (isHost, code) => {
                game.state.flags.isMultiplayer = true;
                game.state.flags.isHost = isHost;
                game.state.flags.currentMultiCode = code;
                
                game.clearScreen();
                
                if (isHost) {
                    btnStopMulti.style.display = 'block';
                    btnLeaveMulti.style.display = 'none';
                    game.state.flags.playerName = game.state.flags.playerName || "Adept Elara";
                    game.printLine(`{{cyan}}System: Global Session [${code}] started. Hosting as ${game.state.flags.playerName}.{{color_reset}}`);
                } else {
                    btnStopMulti.style.display = 'none';
                    btnLeaveMulti.style.display = 'block';
                    game.state.flags.playerName = game.state.flags.playerName || "Adept Kael";
                    game.printLine(`{{yellow}}System: Connected Globally to [${code}] as ${game.state.flags.playerName}.{{color_reset}}`);
                    window.broadcastMsg('join', { name: game.state.flags.playerName });
                }

                // ... [commands and movement remain identical] ...
                game.registerCommand('emote', {
                    description: 'Perform an action',
                    execute: (args) => {
                        if (args.length === 0) return false;
                        const action = args.join(' ');
                        game.printLine(`{{magenta}}* ${game.state.flags.playerName} ${action}{{color_reset}}`);
                        window.broadcastMsg('emote', { action });
                        return true;
                    }
                });
                game.registerAlias('me', 'emote');

                game.registerCommand('say', {
                    description: 'Speak: <optional-any-text> "<say-text>"',
                    execute: (args) => {
                        const rawInput = `say ${args.join(' ')}`.trim();
                        if (!handleSayInput(rawInput)) {
                            game.printLine('{{red}}Usage: <optional-any-text> "<say-text>"{{color_reset}}');
                        }
                        return true;
                    }
                });

                const originalMoveToRoom = game.moveToRoom;
                game.moveToRoom = function(roomId) {
                    const oldRoomId = this.state.currentRoom;
                    const oldRoom = this.world.rooms.get(oldRoomId);
                    originalMoveToRoom.call(this, roomId);
                    if (this.state.currentRoom === roomId && oldRoomId !== roomId) {
                        const newRoom = this.world.rooms.get(roomId);
                        let dir = "away";
                        if (oldRoom && oldRoom.exits) {
                            for (const d in oldRoom.exits) if (oldRoom.exits[d] === roomId) { dir = d; break; }
                        }
                        window.broadcastMsg('move', { dir, roomName: newRoom.name });
                    }
                };

                const currentRoom = game.world.rooms.get(game.state.currentRoom);
                if (currentRoom && (!currentRoom.characters || !currentRoom.characters.includes('desdemona'))) {
                    currentRoom.characters = currentRoom.characters || [];
                    currentRoom.characters.push('desdemona');
                }

                game.describeRoom();
                updateGUI();
            };

            document.getElementById('btn-multi-host').onclick = () => {
                const code = "LORE-" + Math.random().toString(36).substring(2, 8).toUpperCase();
                game.printLine(`{{gray}}Starting peer server connection...{{color_reset}}`);
                
                peer = new Peer(code, PEER_CONFIG);
                
                peer.on('open', (id) => {
                    game.printLine(`{{cyan}}System: Handshaking with Peer Server... ID: ${id}{{color_reset}}`);
                    serverCodeDisplay.textContent = id;
                    multiInit.style.display = 'none';
                    multiHosting.style.display = 'block';
                    window.setupMultiplayer(true, id);
                });

                peer.on('disconnected', () => {
                    game.printLine(`{{yellow}}System: Disconnected from Peer Server. Reconnecting...{{color_reset}}`);
                    peer.reconnect();
                });

                peer.on('close', () => {
                    game.printLine(`{{red}}System: Peer Network Connection Closed.{{color_reset}}`);
                });

                document.getElementById('btn-copy-invite').onclick = () => {
                    const url = new URL(window.location.href);
                    url.searchParams.set('join', peer.id);
                    navigator.clipboard.writeText(url.toString()).then(() => {
                        const btn = document.getElementById('btn-copy-invite');
                        const originalText = btn.textContent;
                        btn.textContent = 'COPIED!';
                        setTimeout(() => btn.textContent = originalText, 2000);
                    });
                };

                peer.on('connection', (conn) => {
                    game.printLine(`{{cyan}}System: Incoming connection from ${conn.peer}...{{color_reset}}`);
                    
                    conn.on('open', () => {
                        game.printLine(`{{green}}System: Connection with ${conn.peer} opened successfully.{{color_reset}}`);
                        connections.push(conn);
                    });

                    conn.on('data', (data) => {
                        data.peerId = conn.peer;
                        window.handleIncomingMsg(data);
                    });
                    
                    conn.on('error', (err) => {
                        game.printLine(`{{red}}System: Connection error with ${conn.peer}: ${err}{{color_reset}}`);
                    });

                    conn.on('close', () => {
                        game.printLine(`{{red}}System: Player ${conn.peer} disconnected.{{color_reset}}`);
                        connections = connections.filter(c => c !== conn);
                    });
                });

                peer.on('error', (err) => {
                    game.printLine(`{{red}}Multiplayer Error: ${err.type}{{color_reset}}`);
                    if (err.type === 'unavailable-id') alert('Server code collision. Please try again.');
                });
            };

            const joinSession = (code) => {
                code = code.trim().toUpperCase();
                game.printLine(`{{gray}}System: Initializing Client Peer...{{color_reset}}`);
                
                if (peer) peer.destroy();
                peer = new Peer(undefined, PEER_CONFIG);
                
                peer.on('open', (id) => {
                    game.printLine(`{{gray}}System: Client ID [${id}] ready. Requesting connection to [${code}]...{{color_reset}}`);
                    const conn = peer.connect(code, { reliable: true });
                    
                    const timeout = setTimeout(() => {
                        if (!conn.open) {
                            game.printLine(`{{red}}System: Connection Timed Out. Peer [${code}] is not responding.{{color_reset}}`);
                            peer.destroy();
                        }
                    }, 15000);

                    conn.on('open', () => {
                        clearTimeout(timeout);
                        game.printLine(`{{green}}System: Connection success! Syncing with host...{{color_reset}}`);
                        connections = [conn];
                        serverCodeDisplay.textContent = code;
                        multiInit.style.display = 'none';
                        multiHosting.style.display = 'block';
                        window.setupMultiplayer(false, code);
                    });

                    conn.on('data', (data) => {
                        window.handleIncomingMsg(data);
                    });

                    conn.on('error', (err) => {
                        game.printLine(`{{red}}System: Data Channel Error: ${err.message || err.type || err}{{color_reset}}`);
                    });

                    conn.on('close', () => {
                        game.printLine(`{{red}}System: Connection closed by host.{{color_reset}}`);
                        alert('Disconnected from realm host.');
                        location.reload();
                    });
                });

                peer.on('error', (err) => {
                    let msg = err.message || err.type;
                    if (err.type === 'peer-unavailable') msg = `Realm [${code}] not found.`;
                    game.printLine(`{{red}}System: Peer Error: ${msg}{{color_reset}}`);
                    console.error('PeerJS Detail:', err);
                });
            };

            document.getElementById('btn-multi-join').onclick = () => {
                const rawCode = prompt('Enter Server Code (e.g., LORE-XXXXXX):');
                if (!rawCode) return;
                joinSession(rawCode);
            };

            btnStopMulti.onclick = () => {
                if (peer) {
                    window.broadcastMsg('leave', { name: game.state.flags.playerName });
                    peer.destroy();
                }
                location.reload();
            };

            btnLeaveMulti.onclick = () => {
                if (peer) {
                    window.broadcastMsg('leave', { name: game.state.flags.playerName });
                    peer.destroy();
                }
                location.reload();
            };

            try {
                // Use absolute path logic for GH Pages
                const novelPath = './lemegeton.js';
                await game.loadNovel(novelPath);
                
                // Force an initial GUI update and room description
                game.describeRoom();
                updateGUI();

                // Check for auto-join link
                const urlParams = new URLSearchParams(window.location.search);
                const joinCode = urlParams.get('join');
                if (joinCode) {
                    setTimeout(() => {
                        joinSession(joinCode);
                        // Open the menu to show multiplayer tab
                        menuOverlay.style.display = 'flex';
                        tabs.forEach(t => t.classList.remove('active'));
                        sections.forEach(s => s.classList.remove('active'));
                        const multiTab = document.querySelector('.menu-tab[data-tab="multi"]');
                        if (multiTab) {
                            multiTab.classList.add('active');
                            document.getElementById('tab-multi').classList.add('active');
                        }
                    }, 1000); // Small delay to ensure game is ready
                }
            } catch (e) {
                console.error("Game Load Error:", e);
            }
        });
    </script>
</body>
</html>
